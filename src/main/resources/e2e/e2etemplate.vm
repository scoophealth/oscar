#**
 * Copyright (c) 2013. Department of Family Practice, University of British Columbia. All Rights Reserved.
 * This software is published under the GPL GNU General Public License.
 * This program is free software; you can redistribute it and/or
 * modify it under the terms of the GNU General Public License
 * as published by the Free Software Foundation; either version 2
 * of the License, or (at your option) any later version.
 *
 * This program is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the
 * GNU General Public License for more details.
 *
 * You should have received a copy of the GNU General Public License
 * along with this program; if not, write to the Free Software
 * Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA 02111-1307, USA.
 *
 * This software was written for the
 * Department of Family Practice
 * Faculty of Medicine
 * University of British Columbia
 * Vancouver, Canada
 *
 * @author Jeremy Ho
 *
 *##set( $demographic = $patient.getDemographic() )
<?xml version="1.0" encoding="UTF-8"?>
<!-- Generated by OSCAR EMR $!buildTag.replace("$", "") -->
<hl7:ClinicalDocument xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:schemaLocation="urn:hl7-org:v3 Schemas/CDA-PITO-E2E.xsd"
 xmlns="urn:hl7-org:v3" xmlns:hl7="urn:hl7-org:v3" xmlns:xs="http://www.w3.org/2001/XMLSchema" xmlns:e2e="http://standards.pito.bc.ca/E2E-DTC/cda"
 classCode="DOCCLIN" moodCode="EVN">
<!--
********************************************************
CDA Header
********************************************************
-->
  <realmCode code="CA-BC"/>
  <typeId root="2.16.840.1.113883.1.3" extension="POCD_HD000040"/>
  <!-- Conforms to the BC PITO Standard Header specification -->
  <templateId root="2.16.840.1.113883.3.1818.10.7.1"/>
  <!-- Conforms to the BC PITO EMR Conversion Document specification -->
  <templateId root="2.16.840.1.113883.3.1818.10.1.1"/>
  <id extension="$demographic.demographicNo" root="$randDocGUID"/>
  <code code="11503-0" codeSystem="2.16.840.1.113883.6.1" codeSystemName="LOINC" codeSystemVersion="2.44" displayName="Medical Records">
    <originalText representation="TXT" mediaType="text/plain"/>
  </code>
  <title>PITO EMR-2-EMR Record of $!demographic.firstName $!demographic.lastName</title>
  <effectiveTime value="$dateTool.get('yyyyMMddHHmm')"/>
  <confidentialityCode code="N" codeSystem="2.16.840.1.113883.5.25" displayName="Normal"/>
  <languageCode code="en-CA"/>
  <!--
  ********************************************************
  Record Target
  ********************************************************
  -->
  <recordTarget typeCode="RCT" contextControlCode="OP">
    <patientRole classCode="PAT">
#if ( $stringUtils.isNullOrEmpty($demographic.hin) )
      <id root="2.16.840.1.113883.4.50" extension="000000000" assigningAuthorityName="BC-PHN"/>
#else
      <id root="2.16.840.1.113883.4.50" extension="$demographic.hin" assigningAuthorityName="BC-PHN"/>
#end
#if ( $demographic.address || $demographic.city || $demographic.province || $demographic.postal )
      <addr use="H">
        <delimiter>$!demographic.address</delimiter>
#*    *##if ( !$stringUtils.isNullOrEmpty($demographic.city) )
        <city>$demographic.city</city>
#*    *##end
#*    *##if ( !$stringUtils.isNullOrEmpty($demographic.province) )
        <state>$demographic.province</state>
#*    *##end
#*    *##if ( !$stringUtils.isNullOrEmpty($demographic.postal) )
        <postalCode>$demographic.postal</postalCode>
#*    *##end
      </addr>
#end
#if ( !$stringUtils.isNullOrEmpty($demographic.phone) )
      <telecom value="tel:$demographic.phone.replaceAll("-","")" use="H"/>
#end
#if ( !$stringUtils.isNullOrEmpty($demographic.phone2) )
      <telecom value="tel:$demographic.phone2.replaceAll("-","")" use="WP"/>
#end
#if ( !$stringUtils.isNullOrEmpty($demographic.email) )
      <telecom value="mailto:$demographic.email" use="H"/>
#end
      <patient classCode="PSN" determinerCode="INSTANCE">
        <name use="L">
          <given>$demographic.firstName</given>
          <family>$demographic.lastName</family>
        </name>
        <administrativeGenderCode code="$demographic.sex.replace("U","UN")" codeSystem="2.16.840.1.113883.5.1" codeSystemName="HL7 - Administrative Gender" displayName="$patient.genderDesc"/>
        <birthTime value="$patient.birthDate"/>
        <languageCommunication>
#if ( $demographic.officialLanguage == "English" )
          <languageCode code="EN"/>
#else
          <languageCode code="FR"/>
#end
        </languageCommunication>
      </patient>
    </patientRole>
  </recordTarget>
  <!--
  ********************************************************
  Author
  ********************************************************
  -->
  <author typeCode="AUT" contextControlCode="OP">
    <time value="$dateTool.get('yyyyMMdd')"/>
    <assignedAuthor classCode="ASSIGNED">
      <id root="$patient.getProviderRoot($patient.authorId)" extension="$patient.getProviderID($patient.authorId)"/>
#if ( !$stringUtils.isNullOrEmpty($patient.getProviderHomePhone($patient.authorId)) )
      <telecom value="tel:$patient.getProviderHomePhone($patient.authorId).replaceAll("-","")" use="H"/>
#end
#if ( !$stringUtils.isNullOrEmpty($patient.getProviderWorkPhone($patient.authorId)) )
      <telecom value="tel:$patient.getProviderWorkPhone($patient.authorId).replaceAll("-","")" use="WP"/>
#end
#if ( !$stringUtils.isNullOrEmpty($patient.getProviderEmail($patient.authorId)) )
      <telecom value="mailto:$patient.getProviderEmail($patient.authorId)" use="WP"/>
#end
      <assignedPerson classCode="PSN" determinerCode="INSTANCE">
        <name use="L">
          <given>$patient.getProviderFirstName($patient.authorId)</given>
          <family>$patient.getProviderLastName($patient.authorId)</family>
        </name>
      </assignedPerson>
    </assignedAuthor>
  </author>
  <author typeCode="AUT" contextControlCode="OP">
    <time value="$dateTool.get('yyyyMMdd')"/>
    <assignedAuthor classCode="ASSIGNED">
      <id root="2.16.840.1.113883.3.40.2.11" extension="$patient.getProviderID($patient.authorId)"/>
#if ( !$stringUtils.isNullOrEmpty($patient.getProviderHomePhone($patient.authorId)) )
      <telecom value="tel:$patient.getProviderHomePhone($patient.authorId).replaceAll("-","")" use="H"/>
#end
#if ( !$stringUtils.isNullOrEmpty($patient.getProviderWorkPhone($patient.authorId)) )
      <telecom value="tel:$patient.getProviderWorkPhone($patient.authorId).replaceAll("-","")" use="WP"/>
#end
#if ( !$stringUtils.isNullOrEmpty($patient.getProviderEmail($patient.authorId)) )
      <telecom value="mailto:$patient.getProviderEmail($patient.authorId)" use="WP"/>
#end
      <assignedAuthoringDevice classCode="DEV" determinerCode="INSTANCE">
        <softwareName language="en-US">OSCAR EMR $!buildTag.replace("$", "")</softwareName>
      </assignedAuthoringDevice>
    </assignedAuthor>
  </author>
  <!--
  ********************************************************
  Custodian
  ********************************************************
  -->
  <custodian typeCode="CST">
    <assignedCustodian classCode="ASSIGNED">
      <representedCustodianOrganization classCode="ORG" determinerCode="INSTANCE">
        <id root="2.16.840.1.113883.3.3331" extension="$custodian.id"/>
        <name>$custodian.clinicName</name>
      </representedCustodianOrganization>
    </assignedCustodian>
  </custodian>
  <!--
  ********************************************************
  Information Recipient
  ********************************************************
  -->
  <informationRecipient typeCode="PRCP" nullFlavor="NA">
    <intendedRecipient/>
  </informationRecipient>
<!--
********************************************************
e-MS CDA Structured Body
********************************************************
-->
  <component typeCode="COMP" contextConductionInd="true">
    <structuredBody classCode="DOCBODY" moodCode="EVN">
      <confidentialityCode code="N" codeSystem="2.16.840.1.113883.5.25" displayName="Normal"/>
      <languageCode code="en-CA"/>
<!--
********************************************************
Advance Directives
********************************************************
-->
      <component typeCode="COMP" contextConductionInd="true">
        <section classCode="DOCSECT" moodCode="EVN">
          <templateId root="2.16.840.1.113883.3.1818.10.2.2"/>
          <code code="42348-3" codeSystem="2.16.840.1.113883.6.1" codeSystemName="LOINC" displayName="Advance Directives"/>
          <title>Advance Directives Section [without entries]</title>
          <text mediaType="text/x-hl7-text+xml">$notSupported</text>
          <entry nullFlavor="NA" typeCode="DRIV" contextConductionInd="true">
            <observation nullFlavor="NA" classCode="OBS" moodCode="EVN">
              <id root="2.16.840.1.113883.3.3331" extension="AdvanceDirectives-0" assigningAuthorityName="OSCAR EMR"/>
              <code nullFlavor="NA"/>
              <text nullFlavor="NA"/>
              <statusCode code="Completed"/>
              <effectiveTime nullFlavor="NA"/>
            </observation>
          </entry>
        </section>
      </component>
<!--
********************************************************
Alerts
********************************************************
-->
#if ( $patient.hasAlerts() )
      <component typeCode="COMP" contextConductionInd="true">
        <section classCode="DOCSECT" moodCode="EVN">
          <templateId root="2.16.840.1.113883.3.1818.10.2.3.1"/>
          <code code="ALERTS" codeSystem="2.16.840.1.113883.3.3068.10.6.2" codeSystemName="SectionType-CA-Pending" displayName="Alerts"/>
          <title>Alerts [with entries]</title>
          <text mediaType="text/x-hl7-text+xml">
            <list>
#**##foreach ( $alert in $patient.getAlerts() )
              <item>$!patient.cleanString($alert.note)</item>
#**##end
            </list>
          </text>
#**##foreach ( $alert in $patient.getAlerts() )
          <!--Alert Observation-->
          <entry typeCode="DRIV" contextConductionInd="true">
            <templateId root="2.16.840.1.113883.3.1818.10.3.2"/>
            <observation classCode="OBS" moodCode="EVN">
              <id root="2.16.840.1.113883.3.3331" extension="Alerts-$alert.id" assigningAuthorityName="OSCAR EMR"/>
              <code nullFlavor="NI"/>
              <text representation="TXT" mediaType="text/plain">$!patient.cleanString($alert.note)</text>
#*    *##if ( !$alert.isArchived() )
              <statusCode code="active"/>
#*    *##else
              <statusCode code="complete"/>
#*    *##end
#*    *##if ( $alert.getObservation_date() )
              <effectiveTime xsi:type="IVL_TS">
                <low value="$dateTool.format('yyyyMMddHHmmss', $alert.getObservation_date())"/>
              </effectiveTime>
#*    *##else
              <effectiveTime nullFlavor="NI"/>
#*    *##end
              <e2e:confidentialityCode code="N" codeSystem="2.16.840.1.113883.5.25" displayName="Normal"/>
            </observation>
          </entry>
#**##end
        </section>
      </component>
#else
      <component typeCode="COMP" contextConductionInd="true">
        <section classCode="DOCSECT" moodCode="EVN">
          <templateId root="2.16.840.1.113883.3.1818.10.2.3"/>
          <code code="ALERTS" codeSystem="2.16.840.1.113883.3.3068.10.6.2" codeSystemName="SectionType-CA-Pending" displayName="Alerts"/>
          <title>Alerts [without entries]</title>
          <text mediaType="text/x-hl7-text+xml">$noInformation</text>
          <entry nullFlavor="NI" typeCode="DRIV" contextConductionInd="true">
            <templateId root="2.16.840.1.113883.3.1818.10.3.2"/>
            <observation nullFlavor="NI" classCode="OBS" moodCode="EVN">
              <id root="2.16.840.1.113883.3.3331" extension="Alerts-0" assigningAuthorityName="OSCAR EMR"/>
              <code nullFlavor="NI"/>
              <text nullFlavor="NI"/>
              <statusCode code="completed"/>
              <effectiveTime nullFlavor="NI"/>
              <e2e:confidentialityCode nullFlavor="NI"/>
            </observation>
          </entry>
        </section>
      </component>
#end
<!--
********************************************************
Allergies and Intolerances - (Reaction List)
********************************************************
-->
#if ( $patient.hasAllergies() )
      <component typeCode="COMP" contextConductionInd="true">
        <section classCode="DOCSECT" moodCode="EVN">
          <templateId root="2.16.840.1.113883.3.1818.10.2.4.1"/>
          <code code="48765-2" codeSystem="2.16.840.1.113883.6.1" codeSystemName="LOINC" displayName="Allergies and or Adverse Reactions Doc"/>
          <title>Allergies &amp; Intolerances (Reaction List) [with entries]</title>
          <text mediaType="text/x-hl7-text+xml">
            <list>
#**##foreach ( $allergy in $patient.getAllergies() )
              <item>$!patient.cleanString($allergy.description)</item>
#**##end
            </list>
          </text>
#**##foreach ( $allergy in $patient.getAllergies() )
          <entry typeCode="DRIV" contextConductionInd="true">
            <templateId root="2.16.840.1.113883.3.1818.10.3.3"/>
            <!-- Allergy and Intolerance Observation -->
            <act classCode="ACT" moodCode="EVN">
              <id root="2.16.840.1.113883.3.3331" extension="Allergies-$allergy.id" assigningAuthorityName="OSCAR EMR"/>
              <code code="CONC" displayName="Concern" codeSystem="2.16.840.1.113883.5.6" codeSystemName="ActClass"/>
#*    *##if ( !$allergy.archived )
              <statusCode code="active"/>
#*    *##else
              <statusCode code="completed"/>
#*    *##end
#*    *##if ( $allergy.getLastUpdateDate() )
              <effectiveTime xsi:type="IVL_TS">
                <low value="$dateTool.format('yyyyMMdd', $allergy.getLastUpdateDate())"/>
              </effectiveTime>
#*    *##else
              <effectiveTime nullFlavor="UNK"/>
#*    *##end
              <entryRelationship typeCode="COMP" contextConductionInd="true">
                <observation classCode="OBS" moodCode="EVN">
#*    *##if ( $allergy.typeCode == 8 || $allergy.typeCode == 10 || $allergy.typeCode == 11 || $allergy.typeCode == 13 )
                  <code code="MED" displayName="Medication" codeSystem="2.16.840.1.113883.5.4" codeSystemName="HL7 ActCode"/>
#*    *##elseif ( $allergy.typeCode == 12 || $allergy.typeCode == 14 )
                  <code code="SUB" displayName="Substance" codeSystem="2.16.840.1.113883.5.4" codeSystemName="HL7 ActCode"/>
#*    *##else
                  <code nullFlavor="UNK"/>
#*    *##end
#*    *##if ( $allergy.getStartDate() )
                  <effectiveTime xsi:type="IVL_TS">
                    <low value="$dateTool.format('yyyyMMdd', $allergy.getStartDate())"/>
                  </effectiveTime>
#*    *##else
                  <effectiveTime nullFlavor="UNK"/>
#*    *##end
                  <participant typeCode="CSM" contextControlCode="OP">
                    <participantRole classCode="MANU">
                      <playingEntity classCode="MMAT" determinerCode="INSTANCE">
#*    *##if ( !$stringUtils.isNullOrEmpty($allergy.regionalIdentifier) )
                        <code code="$allergy.regionalIdentifier" displayName="$allergy.description" codeSystem="2.16.840.1.113883.5.1105" codeSystemName="HC-DIN"/>
#*    *##else
                        <code nullFlavor="NI"/>
#*    *##end
                        <name>$allergy.description</name>
                      </playingEntity>
                    </participantRole>
                  </participant>
                  <!-- Allergen Group Observation -->
                  <entryRelationship typeCode="COMP" contextConductionInd="true">
                    <observation classCode="OBS" moodCode="EVN">
                      <code code="ALLGRP" displayName="Allergen Group Code" codeSystem="2.16.840.1.113883.3.3068.10.6.3" codeSystemName="ObservationType-CA-Pending"/>
                      <value xsi:type="CD" nullFlavor="NI" displayName="No Information"/>
                    </observation>
                  </entryRelationship>
#*    *##if ( $allergy.lifeStage.equals("N") || $allergy.lifeStage.equals("I") || $allergy.lifeStage.equals("C") || $allergy.lifeStage.equals("T") || $allergy.lifeStage.equals("A") )
                  <!-- Lifestage at Onset -->
                  <entryRelationship typeCode="COMP" contextConductionInd="true">
                    <templateId root="2.16.840.1.113883.3.1818.10.4.12"/>
                    <!--Lifestage Observation-->
                    <observation classCode="OBS" moodCode="EVN">
                      <code code="LIFEOBS" displayName="Lifestage Observation" codeSystem="2.16.840.1.113883.3.3068.10.6.3" codeSystemName="ObservationType-CA-Pending"/>
#*        *##if ( $allergy.lifeStage.equals("N") )
                      <value xsi:type="CD" code="133933007" displayName="Newborn" codeSystem="2.16.840.1.113883.3.3068.10.8.19" codeSystemName="LifeStageObservationValue-CA-Pending"/>
#*        *##elseif ( $allergy.lifeStage.equals("I") )
                      <value xsi:type="CD" code="133931009" displayName="Infant" codeSystem="2.16.840.1.113883.3.3068.10.8.19" codeSystemName="LifeStageObservationValue-CA-Pending"/>
#*        *##elseif ( $allergy.lifeStage.equals("C") )
                      <value xsi:type="CD" code="410601007" displayName="Child" codeSystem="2.16.840.1.113883.3.3068.10.8.19" codeSystemName="LifeStageObservationValue-CA-Pending"/>
#*        *##elseif ( $allergy.lifeStage.equals("T") )
                      <value xsi:type="CD" code="133937008" displayName="Adolescent" codeSystem="2.16.840.1.113883.3.3068.10.8.19" codeSystemName="LifeStageObservationValue-CA-Pending"/>
#*        *##else
                      <value xsi:type="CD" code="133936004" displayName="Adult" codeSystem="2.16.840.1.113883.3.3068.10.8.19" codeSystemName="LifeStageObservationValue-CA-Pending"/>
#*        *##end
                    </observation>
                  </entryRelationship>
#*    *##end
#*    *##if ( $allergy.reaction )
                  <!-- Reaction -->
                  <entryRelationship typeCode="COMP" contextConductionInd="true">
                    <templateId root="2.16.840.1.113883.3.1818.10.4.23"/>
                    <!-- Reaction Observation -->
                    <observation classCode="OBS" moodCode="EVN">
                      <code code="REACTOBS" displayName="Reaction Observation" codeSystem="2.16.840.1.113883.3.3068.10.6.3" codeSystemName="ObservationType-CA-Pending"/>
                      <text representation="TXT" mediaType="text/plain">$patient.cleanString($allergy.reaction)</text>
#*        *##if ( $allergy.getStartDate() )
                      <effectiveTime xsi:type="IVL_TS">
                        <low value="$dateTool.format('yyyyMMdd', $allergy.getStartDate())"/>
                      </effectiveTime>
#*        *##else
                      <effectiveTime nullFlavor="UNK"/>
#*        *##end
                      <value xsi:type="CD" nullFlavor="NI" displayName="No Information"/>
#*        *##if ( $allergy.providerNo )
                      <!-- Author Participation -->
                      <author typeCode="AUT" contextControlCode="OP">
                        <templateId root="2.16.840.1.113883.3.1818.10.4.2"/>
                        <!-- Author Participation -->
#*            *##if ( $allergy.getEntryDate() )
                        <time value="$dateTool.format('yyyyMMdd', $allergy.getEntryDate())"/>
#*            *##else
                        <time nullFlavor="UNK"/>
#*            *##end
                        <assignedAuthor classCode="ASSIGNED">
                          <id root="2.16.840.1.113883.3.40.2.11" extension="$patient.getProviderID($allergy.providerNo)" use="BUS"/>
                          <assignedPerson classCode="PSN" determinerCode="INSTANCE">
                            <name use="L">
                              <given>$patient.getProviderFirstName($allergy.providerNo)</given>
                              <family>$patient.getProviderLastName($allergy.providerNo)</family>
                            </name>
                          </assignedPerson>
                        </assignedAuthor>
                      </author>
#*        *##end
                      <!-- Reaction Severity -->
                      <entryRelationship typeCode="COMP" contextConductionInd="true">
                        <templateId root="2.16.840.1.113883.3.1818.10.4.30"/>
                        <!-- Severity Observation -->
                        <observation classCode="OBS" moodCode="EVN">
                          <code code="SEV" displayName="Severity" codeSystem="2.16.840.1.113883.5.4" codeSystemName="HL7 ActCode"/>
#*        *##if ( $allergy.severityOfReaction == 1 )
                          <value xsi:type="CD" code="A2" displayName="Mild reaction" codeSystem="2.16.840.1.113883.5.1063" codeSystemName="HL7 ObservationValue"/>
#*        *##elseif ( $allergy.severityOfReaction == 2 )
                          <value xsi:type="CD" code="A3" displayName="Moderate reaction" codeSystem="2.16.840.1.113883.5.1063" codeSystemName="HL7 ObservationValue"/>
#*        *##elseif ( $allergy.severityOfReaction == 3 )
                          <value xsi:type="CD" code="A4" displayName="Severe reaction" codeSystem="2.16.840.1.113883.5.1063" codeSystemName="HL7 ObservationValue"/>
#*        *##else
                          <value xsi:type="CD" nullFlavor="UNK" displayName="Unknown"/>
#*        *##end
                        </observation>
                      </entryRelationship>
                    </observation>
                  </entryRelationship>
#*    *##end
                  <!-- Reaction Severity -->
                  <entryRelationship typeCode="COMP" contextConductionInd="true">
                    <templateId root="2.16.840.1.113883.3.1818.10.4.30"/>
                    <!-- Severity Observation -->
                    <observation classCode="OBS" moodCode="EVN">
                      <code code="SEV" displayName="Severity" codeSystem="2.16.840.1.113883.5.4" codeSystemName="HL7 ActCode"/>
#*    *##if ( $allergy.severityOfReaction == 1 )
                      <value xsi:type="CD" code="A2" displayName="Mild reaction" codeSystem="2.16.840.1.113883.5.1063" codeSystemName="HL7 ObservationValue"/>
#*    *##elseif ( $allergy.severityOfReaction == 2 )
                      <value xsi:type="CD" code="A3" displayName="Moderate reaction" codeSystem="2.16.840.1.113883.5.1063" codeSystemName="HL7 ObservationValue"/>
#*    *##elseif ( $allergy.severityOfReaction == 3 )
                      <value xsi:type="CD" code="A4" displayName="Severe reaction" codeSystem="2.16.840.1.113883.5.1063" codeSystemName="HL7 ObservationValue"/>
#*    *##else
                      <value xsi:type="CD" nullFlavor="UNK" displayName="Unknown"/>
#*    *##end
                    </observation>
                  </entryRelationship>
                  <!-- Allergy Clinical Status -->
                  <entryRelationship typeCode="SUBJ" contextConductionInd="true">
                    <observation classCode="OBS" moodCode="EVN">
                      <code code="CLINSTAT" displayName="Allergy Clinical Status" codeSystem="2.16.840.1.113883.3.3068.10.6.3" codeSystemName="ObservationType-CA-Pending"/>
#*    *##if ( !$allergy.archived )
                      <text representation="TXT" mediaType="text/plain">Confirmed present</text>
                      <value xsi:type="CD" code="410605003" displayName="Confirmed present" codeSystem="2.16.840.1.113883.6.96" codeSystemName="SNOMED-CT"/>
#*    *##else
                      <text representation="TXT" mediaType="text/plain">Cancelled</text>
                      <value xsi:type="CD" code="89925002" displayName="Cancelled" codeSystem="2.16.840.1.113883.6.96" codeSystemName="SNOMED-CT"/>
#*    *##end
                    </observation>
                  </entryRelationship>
                </observation>
              </entryRelationship>
            </act>
          </entry>
#**##end
        </section>
      </component>
#else
      <component typeCode="COMP" contextConductionInd="true">
        <section classCode="DOCSECT" moodCode="EVN">
          <templateId root="2.16.840.1.113883.3.1818.10.2.4"/>
          <code code="48765-2" codeSystem="2.16.840.1.113883.6.1" codeSystemName="LOINC" displayName="Allergies andor Adverse Reactions Doc"/>
          <title>Allergies and Intolerances (Reaction List) [without entries]</title>
          <text mediaType="text/x-hl7-text+xml">$noInformation</text>
          <entry nullFlavor="NI" typeCode="DRIV" contextConductionInd="true">
            <templateId root="2.16.840.1.113883.3.1818.10.3.3"/>
            <act nullFlavor="NI" classCode="ACT" moodCode="EVN">
              <id root="2.16.840.1.113883.3.3331" extension="Allergies-0" assigningAuthorityName="OSCAR EMR"/>
              <code code="CONC" codeSystem="2.16.840.1.113883.5.6" codeSystemName="ActClass"/>
              <statusCode nullFlavor="NI"/>
              <effectiveTime nullFlavor="NI"/>
              <entryRelationship nullFlavor="NI" typeCode="COMP" contextConductionInd="true">
                <observation nullFlavor="NI" classCode="OBS" moodCode="EVN">
                  <code nullFlavor="NI"/>
                  <effectiveTime nullFlavor="NI"/>
                  <participant nullFlavor="NI" typeCode="CSM" contextControlCode="OP">
                    <participantRole nullFlavor="NI" classCode="MANU">
                      <playingEntity nullFlavor="NI" classCode="MMAT" determinerCode="INSTANCE">
                        <code nullFlavor="NI"/>
                        <name nullFlavor="NI"/>
                      </playingEntity>
                    </participantRole>
                  </participant>
                  <entryRelationship nullFlavor="NI" typeCode="SUBJ" contextConductionInd="true">
                    <observation nullFlavor="NI" classCode="OBS" moodCode="EVN">
                      <code code="SEV" codeSystem="2.16.840.1.113883.5.4" codeSystemName="HL7 ActCode"/>
                    </observation>
                  </entryRelationship>
                  <entryRelationship nullFlavor="NI" typeCode="SUBJ" contextConductionInd="true">
                    <observation nullFlavor="NI" classCode="OBS" moodCode="EVN">
                      <code code="CLINSTAT" codeSystem="2.16.840.1.113883.3.3068.10.6.3" codeSystemName="ObservationType-CA-Pending"/>
                      <text nullFlavor="NI"/>
                      <value xsi:type="CD" nullFlavor="NI"/>
                    </observation>
                  </entryRelationship>
                </observation>
              </entryRelationship>
            </act>
          </entry>
        </section>
      </component>
#end
#if ( $patient.hasMeasurements() )
<!--
********************************************************
Clinically Measured Observation
********************************************************
-->
      <component typeCode="COMP" contextConductionInd="true">
        <section classCode="DOCSECT" moodCode="EVN">
          <templateId root="2.16.840.1.113883.3.1818.10.2.8.1"/>
          <code code="CLINOBS" codeSystem="2.16.840.1.113883.3.3068.10.6.2" codeSystemName="SectionType-CA-Pending" displayName="Clinically Measured Observations"/>
          <title>Clinical Measured Observations [with entries]</title>
          <text mediaType="text/x-hl7-text+xml">
            <list>
#**##foreach ( $measurement in $patient.getMeasurements() )
              <item>$!patient.cleanString($!patient.getTypeDescription($measurement.type)): $!patient.cleanString($!measurement.dataField) $!patient.cleanString($!e2e.measurementUnitMap($measurement.type)) ($!patient.cleanString($!measurement.measuringInstruction))</item>
#**##end
            </list>
          </text>
#**##foreach ( $measurement in $patient.getMeasurements() )
          <entry typeCode="DRIV" contextConductionInd="true">
            <templateId root="2.16.840.1.113883.3.1818.10.3.7"/>
            <!-- Clinically Measured Observations Organizer -->
            <organizer classCode="CLUSTER" moodCode="EVN">
              <id root="2.16.840.1.113883.3.3331" extension="ClinicalMeasuredObservations-$measurement.id" assigningAuthorityName="OSCAR EMR"/>
              <code nullFlavor="NI"/>
              <statusCode code="completed"/>
              <author typeCode="AUT" contextControlCode="OP">
                <templateId root="2.16.840.1.113883.3.1818.10.4.2"/>
                <!-- Author Participation -->
#*    *##if ( $measurement.getCreateDate() )
                <time value="$dateTool.format('yyyyMMddHHmmss', $measurement.getCreateDate())"/>
#*    *##else
                <time nullFlavor="UNK"/>
#*    *##end
                <assignedAuthor classCode="ASSIGNED">
                  <id root="2.16.840.1.113883.3.40.2.11" extension="$patient.getProviderID($measurement.providerNo)" use="BUS"/>
                  <assignedPerson classCode="PSN" determinerCode="INSTANCE">
                    <name use="L">
                      <given>$patient.getProviderFirstName($measurement.providerNo)</given>
                      <family>$patient.getProviderLastName($measurement.providerNo)</family>
                    </name>
                  </assignedPerson>
                </assignedAuthor>
              </author>
              <component typeCode="COMP" contextConductionInd="true">
                <observation classCode="OBS" moodCode="EVN">
                  <id root="2.16.840.1.113883.3.3331" extension="ClinicalMeasuredObservations-$measurement.id"/>
                  <!-- OSCAR Type Code: $measurement.type -->
#*    *##if ( $e2e.measurementCodeMap($measurement.type) )
                  <code code="$e2e.measurementCodeMap($measurement.type)" displayName="$patient.getTypeDescription($measurement.type)" codeSystem="2.16.840.1.113883.6.1" codeSystemName="LOINC" codeSystemVersion="2.44"/>
#*    *##else
                  <code nullFlavor="UNK"/>
#*    *##end
                  <text representation="TXT" mediaType="text/plain">$patient.cleanString($patient.getTypeDescription($measurement.type)) ($patient.cleanString($measurement.measuringInstruction))</text>
#*    *##if ( $measurement.getDateObserved() )
                  <effectiveTime xsi:type="IVL_TS">
                    <low value="$dateTool.format('yyyyMMddHHmmss', $measurement.getDateObserved())"/>
                  </effectiveTime>
#*    *##else
                  <effectiveTime nullFlavor="UNK"/>
#*    *##end
#*    *##if ( $e2e.measurementUnitMap($measurement.type) )
                  <value xsi:type="PQ" value="$measurement.dataField" unit="$e2e.measurementUnitMap($measurement.type)"/>
#*    *##else
                  <value xsi:type="ST">$measurement.dataField</value>
#*    *##end
                </observation>
              </component>
            </organizer>
          </entry>
#**##end
        </section>
      </component>
#end
## Section cardinality is optional
#*      <component typeCode="COMP" contextConductionInd="true">
        <section classCode="DOCSECT" moodCode="EVN">
          <templateId root="2.16.840.1.113883.3.1818.10.2.8"/>
          <code code="CLINOBS" codeSystem="2.16.840.1.113883.3.3068.10.6.2" codeSystemName="SectionType-CA-Pending" displayName="Clinically Measured Observations"/>
          <title>Clinical Measured Observations [without entries]</title>
          <text mediaType="text/x-hl7-text+xml">$noInformation</text>
        </section>
      </component>
*#<!--
********************************************************
Encounter History and Notes
********************************************************
-->
#if ( $patient.hasEncounters() )
      <component typeCode="COMP" contextConductionInd="true">
        <section classCode="DOCSECT" moodCode="EVN">
          <templateId root="2.16.840.1.113883.3.1818.10.2.12.1"/>
          <code code="46240-8" codeSystem="2.16.840.1.113883.6.1" codeSystemName="LOINC" displayName="History of hospitalizations+History of outpatient visits"/>
          <title>Encounter History and Notes [with entries]</title>
          <text mediaType="text/x-hl7-text+xml">
            <list>
#**##foreach ( $encounter in $patient.getEncounters() )
              <item>$!dateTool.format('MMM dd, yyyy', $encounter.getObservation_date()) $!patient.cleanString($encounter.note)</item>
#**##end
            </list>
          </text>
#**##foreach ( $encounter in $patient.getEncounters() )
          <entry typeCode="DRIV" contextConductionInd="true">
            <templateId root="2.16.840.1.113883.3.1818.10.3.9"/>
            <!-- Encounter Event -->
            <encounter classCode="ENC" moodCode="EVN">
              <id root="2.16.840.1.113883.3.3331" extension="Encounters-$encounter.id" use="BUS" assigningAuthorityName="OSCAR EMR"/>
#*    *##if ( $encounter.observation_date )
              <effectiveTime xsi:type="IVL_TS">
                <low value="$dateTool.format('yyyyMMddHHmmss', $encounter.getObservation_date())"/>
              </effectiveTime>
#*    *##else
              <effectiveTime nullFlavor="UNK"/>
#*    *##end
              <!-- Encounter Location -->
              <participant typeCode="LOC" contextControlCode="OP">
                <templateId root="2.16.840.1.113883.3.1818.10.4.21"/>
                <participantRole classCode="ROL">
                  <id root="2.16.840.1.113883.3.40.2.11" extension="$custodian.id" use="BUS"/>
                </participantRole>
              </participant>
              <!-- Encounter Provider -->
              <participant typeCode="PRF" contextControlCode="OP">
                <templateId root="2.16.840.1.113883.3.1818.10.4.21"/>
                <!-- Provider Participation -->
                <participantRole classCode="PROV">
                  <id root="2.16.840.1.113883.3.40.2.11" extension="$patient.getProviderID($encounter.providerNo)" use="BUS"/>
                  <playingEntity classCode="PSN" determinerCode="INSTANCE">
                    <name use="L">
                      <given>$patient.getProviderFirstName($encounter.providerNo)</given>
                      <family>$patient.getProviderLastName($encounter.providerNo)</family>
                    </name>
                    <desc>Provider</desc>
                  </playingEntity>
                </participantRole>
              </participant>
              <!-- Encounter Reason -->
              <entryRelationship typeCode="SUBJ" contextConductionInd="true">
                <templateId root="2.16.840.1.113883.3.1818.10.4.24"/>
                <!-- Reason Observation -->
                <observation classCode="OBS" moodCode="EVN">
                  <!-- Record ID -->
                  <id nullFlavor="NI"/>
                  <code code="REASON" displayName="Reason Observation" codeSystem="2.16.840.1.113883.3.3068.10.6.3" codeSystemName="ObservationType-CA-Pending"/>
                  <text representation="TXT" mediaType="text/plain">$patient.cleanString($encounter.note)</text>
#*    *##if ( $encounter.getObservation_date() )
                  <effectiveTime xsi:type="IVL_TS">
                    <low value="$dateTool.format('yyyyMMddHHmmss', $encounter.getObservation_date())"/>
                  </effectiveTime>
#*    *##else
                  <effectiveTime nullFlavor="UNK"/>
#*    *##end
#*    *##if ( !$stringUtils.isNullOrEmpty($encounter.Billing_code) )
                  <value xsi:type="CD" code="$encounter.Billing_code" codeSystem="2.16.840.1.113883.6.42" codeSystemName="ICD9" displayName="$patient.getICD9Description("$encounter.getBilling_code()").replaceAll("&","AND")"/>
#*    *##else
                  <value xsi:type="CD" nullFlavor="NI"/>
#*    *##end
                  <!-- Reason Author -->
                  <author typeCode="AUT" contextControlCode="OP">
                    <templateId root="2.16.840.1.113883.3.1818.10.4.2"/>
                    <!-- Author Participation -->
#*    *##if ( $encounter.update_date )
                    <time value="$dateTool.format('yyyyMMddHHmmss', $encounter.getUpdate_date())"/>
#*    *##else
                    <time nullFlavor="UNK"/>
#*    *##end
                    <assignedAuthor classCode="ASSIGNED">
                      <id root="2.16.840.1.113883.3.40.2.11" extension="$patient.getProviderID($encounter.providerNo)" use="BUS"/>
                      <assignedPerson classCode="PSN" determinerCode="INSTANCE">
                        <name use="L">
                          <given>$patient.getProviderFirstName($encounter.providerNo)</given>
                          <family>$patient.getProviderLastName($encounter.providerNo)</family>
                        </name>
                      </assignedPerson>
                    </assignedAuthor>
                  </author>
                  <!-- Record ID Link -->
                  <entryRelationship typeCode="SUBJ" contextConductionInd="true">
                    <templateId root="2.16.840.1.113883.3.1818.10.4.38"/>
                    <observation classCode="OBS" moodCode="EVN">
                      <id nullFlavor="NI"/>
                      <code code="RECLINK" codeSystem="2.16.840.1.113883.3.3068.10.6.3" codeSystemName="ObservationType-CA-Pending"/>
                    </observation>
                  </entryRelationship>
                </observation>
              </entryRelationship>
            </encounter>
          </entry>
#**##end
        </section>
      </component>
#else
      <component typeCode="COMP" contextConductionInd="true">
        <section classCode="DOCSECT" moodCode="EVN">
          <templateId root="2.16.840.1.113883.3.1818.10.2.12"/>
          <code code="46240-8" codeSystem="2.16.840.1.113883.6.1" codeSystemName="LOINC" displayName="History of hospitalizations+History of outpatient visits"/>
          <title>Encounter History and Notes [without entries]</title>
          <text mediaType="text/x-hl7-text+xml">$noInformation</text>
          <entry nullFlavor="NI" typeCode="DRIV" contextConductionInd="true">
            <templateId root="2.16.840.1.113883.3.1818.10.3.9"/>
            <encounter nullFlavor="NI" classCode="ENC" moodCode="EVN">
              <id root="2.16.840.1.113883.3.3331" extension="Encounters-0" assigningAuthorityName="OSCAR EMR"/>
              <effectiveTime nullFlavor="NI"/>
              <participant nullFlavor="NI" typeCode="LOC" contextControlCode="OP">
                <templateId root="2.16.840.1.113883.3.1818.10.4.21"/>
                <participantRole nullFlavor="NI" classCode="ROL"/>
              </participant>
              <participant nullFlavor="NI" typeCode="PRF" contextControlCode="OP">
                <templateId root="2.16.840.1.113883.3.1818.10.4.21"/>
                <participantRole nullFlavor="NI" classCode="PROV"/>
              </participant>
            </encounter>
          </entry>
        </section>
      </component>
#end
<!--
********************************************************
Family History
********************************************************
-->
#if ( $patient.hasFamilyHistory() )
      <component typeCode="COMP" contextConductionInd="true">
        <section classCode="DOCSECT" moodCode="EVN">
          <templateId root="2.16.840.1.113883.3.1818.10.2.13.1"/>
          <code code="10157-6" codeSystem="2.16.840.1.113883.6.1" codeSystemName="LOINC" displayName="History of Family Member Diseases"/>
          <title>Family History [with entries]</title>
          <text mediaType="text/x-hl7-text+xml">
            <list>
#**##foreach ( $family in $patient.getFamilyHistory() )
              <item>$!patient.cleanString($family.note)</item>
#**##end
            </list>
          </text>
#**##foreach ( $family in $patient.getFamilyHistory() )
          <entry typeCode="DRIV" contextConductionInd="true">
            <templateId root="2.16.840.1.113883.3.1818.10.3.10"/>
            <!-- Family History Observation -->
            <observation classCode="OBS" moodCode="EVN">
              <id root="2.16.840.1.113883.3.3331" extension="FamilyHistory-$family.id" assigningAuthorityName="OSCAR EMR"/>
              <code nullFlavor="NI"/>
              <text representation="TXT" mediaType="text/plain">$!patient.cleanString($family.note)</text>
#*    *##if ( $family.observation_date )
              <effectiveTime xsi:type="IVL_TS">
                <low value="$dateTool.format('yyyyMMddHHmmss', $family.getObservation_date())"/>
              </effectiveTime>
#*    *##else
              <effectiveTime nullFlavor="UNK"/>
#*    *##end
              <value xsi:type="CD" nullFlavor="UNK"/>
              <!--Relationship to the Patient-->
              <subject typeCode="SBJ" contextControlCode="OP">
                <relatedSubject classCode="PRS">
#*    *##if ( !$patient.getCMNoteExtValue("$family.getId()", "Relationship").isEmpty() )
#*        *##if ( $e2e.prrCodeMap($patient.getCMNoteExtValue("$family.getId()", "Relationship")) )
                  <code code="$e2e.prrCodeMap($patient.getCMNoteExtValue("$family.getId()", "Relationship"))" displayName="$patient.getCMNoteExtValue("$family.getId()", "Relationship")" codeSystem="2.16.840.1.113883.5.111" codeSystemName="PersonalRelationshipRoleType"/>
#*        *##else
                  <code code="OTH" displayName="$patient.getCMNoteExtValue("$family.getId()", "Relationship")" codeSystem="2.16.840.1.113883.5.111" codeSystemName="PersonalRelationshipRoleType"/>
#*        *##end
#*    *##else
                  <code nullFlavor="UNK"/>
#*    *##end
                </relatedSubject>
              </subject>
#*    *##if ( !$stringUtils.isNullOrEmpty($family.Billing_code) )
              <!-- Diagnosis Billing Code -->
              <entryRelationship typeCode="COMP" contextConductionInd="true">
                <templateId root="2.16.840.1.113883.3.1818.10.4.28"/>
                <!-- Secondary Code (ICD9) -->
                <observation classCode="OBS" moodCode="EVN">
                  <code code="ICD9CODE" displayName="Billing Code" codeSystem="2.16.840.1.113883.3.3068.10.6.3" codeSystemName="ObservationType-CA-Pending"/>
                  <value xsi:type="CD" code="$family.Billing_code" codeSystem="2.16.840.1.113883.1.11.15931" codeSystemName="ICD9" displayName="$patient.getICD9Description("$family.getBilling_code()").replaceAll("&","AND")"/>
                </observation>
              </entryRelationship>
#*    *##end
#*    *##if ( !$patient.getCMNoteExtValue("$family.getId()", "Life Stage").isEmpty() )
              <!-- Lifestage at Onset -->
              <entryRelationship typeCode="COMP" contextConductionInd="true">
                <templateId root="2.16.840.1.113883.3.1818.10.4.12"/>
                <!-- Lifestage Observation -->
                <observation classCode="OBS" moodCode="EVN">
                  <code code="LIFEOBS" codeSystem="2.16.840.1.113883.3.1818.10.2.8.1" codeSystemName="PITO ObservationType" displayName="Lifestage Observation"/>
#*        *##if ( $patient.getCMNoteExtValue("$family.getId()", "Life Stage") == "N")
                  <value xsi:type="CD" code="133933007" displayName="Newborn" codeSystem="2.16.840.1.113883.3.3068.10.8.19" codeSystemName="LifeStageObservationValue-CA-Pending"/>
#*        *##elseif ( $patient.getCMNoteExtValue("$family.getId()", "Life Stage") == "I")
                  <value xsi:type="CD" code="133931009" displayName="Infant" codeSystem="2.16.840.1.113883.3.3068.10.8.19" codeSystemName="LifeStageObservationValue-CA-Pending"/>
#*        *##elseif ( $patient.getCMNoteExtValue("$family.getId()", "Life Stage") == "C")
                  <value xsi:type="CD" code="410601007" displayName="Child" codeSystem="2.16.840.1.113883.3.3068.10.8.19" codeSystemName="LifeStageObservationValue-CA-Pending"/>
#*        *##elseif ( $patient.getCMNoteExtValue("$family.getId()", "Life Stage") == "T")
                  <value xsi:type="CD" code="133937008" displayName="Adolescent" codeSystem="2.16.840.1.113883.3.3068.10.8.19" codeSystemName="LifeStageObservationValue-CA-Pending"/>
#*        *##else
                  <value xsi:type="CD" code="133936004" displayName="Adult" codeSystem="2.16.840.1.113883.3.3068.10.8.19" codeSystemName="LifeStageObservationValue-CA-Pending"/>
#*        *##end
                </observation>
              </entryRelationship>
#*    *##end
#*    *##if ( !$patient.getCMNoteExtValue("$family.getId()", "Age at Onset").isEmpty() )
              <!--Age at Onset-->
              <entryRelationship typeCode="COMP">
                <observation classCode="OBS" moodCode="EVN">
                  <code code="30972-4" displayName="Age at onset" codeSystem="2.16.840.1.113883.6.1" codeSystemName="LOINC"/>
                  <value xsi:type="INT" value="$patient.getCMNoteExtValue("$family.getId()", "Age at Onset")"/>
                </observation>
              </entryRelationship>
#*    *##end
#*    *##if ( !$patient.getCMNoteExtValue("$family.getId()", "Treatment").isEmpty() )
              <!-- Treatment Comment -->
              <entryRelationship typeCode="SUBJ" contextConductionInd="true" inversionInd="true">
                <templateId root="2.16.840.1.113883.3.1818.10.4.3"/>
                <!-- Comment Observation -->
                <observation classCode="OBS" moodCode="EVN">
                  <code code="TRTNOTE" displayName="Treatment Note" codeSystem="2.16.840.1.113883.3.3068.10.6.3" codeSystemName="ObservationType-CA-Pending"/>
                  <text representation="TXT" mediaType="text/plain">$patient.cleanString($patient.getCMNoteExtValue("$family.getId()", "Treatment"))</text>
                  <value xsi:type="CD" nullFlavor="NI"/>
                </observation>
              </entryRelationship>
#*    *##end
            </observation>
          </entry>
#**##end
        </section>
      </component>
#else
      <component typeCode="COMP" contextConductionInd="true">
        <section classCode="DOCSECT" moodCode="EVN">
          <templateId root="2.16.840.1.113883.3.1818.10.2.13"/>
          <code code="10157-6" codeSystem="2.16.840.1.113883.6.1" codeSystemName="LOINC" displayName="History of Family Member Diseases"/>
          <title>Family History [without entries]</title>
          <text mediaType="text/x-hl7-text+xml">$noInformation</text>
          <entry nullFlavor="NI" typeCode="DRIV" contextConductionInd="true">
            <templateId root="2.16.840.1.113883.3.1818.10.3.10"/>
            <observation nullFlavor="NI" classCode="OBS" moodCode="EVN">
              <id root="2.16.840.1.113883.3.3331" extension="FamilyHistory-0" assigningAuthorityName="OSCAR EMR"/>
              <code nullFlavor="NI"/>
              <effectiveTime nullFlavor="NI"/>
              <value xsi:type="CD" nullFlavor="NI"/>
              <subject nullFlavor="NI" typeCode="SBJ" contextControlCode="OP">
                <relatedSubject nullFlavor="NI" classCode="PRS">
                  <code nullFlavor="NI"/>
                </relatedSubject>
              </subject>
            </observation>
          </entry>
        </section>
      </component>
#end
<!--
********************************************************
Immunization List
********************************************************
-->
#if ( $patient.hasImmunizations() )
      <component typeCode="COMP" contextConductionInd="true">
        <section classCode="DOCSECT" moodCode="EVN">
          <templateId root="2.16.840.1.113883.3.1818.10.2.14.1"/>
          <code code="11369-6" codeSystem="2.16.840.1.113883.6.1" codeSystemName="LOINC" displayName="History of Immunization"/>
          <title>Immunizations List [with entries]</title>
          <text mediaType="text/x-hl7-text+xml">
            <list>
#**##foreach( $immunization in $patient.getImmunizations() )
#*    *##if ( $immunization.isRefused() )
              <item>$!patient.cleanString($!immunization.preventionType) $!dateTool.format('MMM dd, yyyy', $immunization.getPreventionDate()) Refused</item>
#*    *##elseif ( $immunization.isIneligible() )
              <item>$!patient.cleanString($!immunization.preventionType) $!dateTool.format('MMM dd, yyyy', $immunization.getPreventionDate()) Ineligible</item>
#*    *##else
              <item>$!patient.cleanString($!immunization.preventionType) $!dateTool.format('MMM dd, yyyy', $immunization.getPreventionDate()) Completed</item>
#*    *##end
#**##end
            </list>
          </text>
#**##foreach( $immunization in $patient.getImmunizations() )
          <entry typeCode="DRIV" contextConductionInd="true">
            <templateId root="2.16.840.1.113883.3.1818.10.3.11"/>
            <!-- Immunization Observation -->
#*    *##if ( $immunization.isRefused() || $immunization.isIneligible() )
            <substanceAdministration classCode="SBADM" moodCode="EVN" negationInd="true">
#*    *##else
            <substanceAdministration classCode="SBADM" moodCode="EVN" negationInd="false">
#*    *##end
              <id root="2.16.840.1.113883.3.3331" extension="Immunizations-$immunization.id" assigningAuthorityName="OSCAR EMR"/>
              <code code="IMMUNIZ" displayName="Immunization" codeSystem="2.16.840.1.113883.5.4" codeSystemName="HL7 ActCode"/>
              <!-- Immunization Date -->
#*    *##if ( $immunization.getPreventionDate() )
              <effectiveTime xsi:type="IVL_TS">
                <low value="$dateTool.format('yyyyMMdd', $immunization.getPreventionDate())"/>
              </effectiveTime>
#*    *##else
              <effectiveTime nullFlavor="UNK"/>
#*    *##end
#*    *##if ( !$patient.getImmuExtValue("$immunization.getId()", "route").isEmpty() )
              <routeCode nullFlavor="OTH" codeSystem="2.16.840.1.113883.5.112" codeSystemName="RouteOfAdministration">
                <originalText representation="TXT" mediaType="text/plain">$patient.getImmuExtValue("$immunization.getId()", "route")</originalText>
              </routeCode>
#*    *##end
## Dose Quantity can't be safely converted from a string to IVL_PQ representation
#*    *##if ( !$patient.getImmuExtValue("$immunization.getId()", "dose").isEmpty() )
              <!-- Dose Quantity and Type-->
              <!-- OSCAR Dose: $!patient.getImmuExtValue("$immunization.getId()", "dose") -->
              <doseQuantity nullFlavor="OTH"/>
#*    *##end
              <!-- Immunization Product (i.e. DIN) -->
              <consumable typeCode="CSM">
                <manufacturedProduct classCode="MANU">
                  <manufacturedMaterial classCode="MMAT" determinerCode="KIND">
#*    *##if ( $e2e.preventionTypeMap($immunization.preventionType) )
                    <code code="$e2e.preventionTypeMap($immunization.preventionType)" codeSystem="2.16.840.1.113883.6.73" codeSystemName="whoATC" displayName="$immunization.preventionType"/>
#*    *##else
                    <code nullFlavor="UNK"/>
#*    *##end
                    <name>$immunization.preventionType</name>
#*    *##if ( !$patient.getImmuExtValue("$immunization.getId()", "lot").isEmpty() )
                    <lotNumberText>$patient.getImmuExtValue("$immunization.getId()", "lot")</lotNumberText>
#*    *##end
                  </manufacturedMaterial>
                </manufacturedProduct>
              </consumable>
              <!-- Immunization Administration Provider -->
              <author typeCode="AUT" contextControlCode="OP">
                <templateId root="2.16.840.1.113883.3.1818.10.4.2"/>
                <!-- Author Participation -->
#*    *##if ( $immunization.getCreationDate() )
                <time value="$dateTool.format('yyyyMMdd', $immunization.getCreationDate())"/>
#*    *##else
                <time nullFlavor="UNK"/>
#*    *##end
                <assignedAuthor classCode="ASSIGNED">
                  <id root="2.16.840.1.113883.3.40.2.11" extension="$patient.getProviderID($immunization.providerNo)" use="BUS"/>
                  <assignedPerson classCode="PSN" determinerCode="INSTANCE">
                    <name use="L">
                      <given>$patient.getProviderFirstName($immunization.providerNo)</given>
                      <family>$patient.getProviderLastName($immunization.providerNo)</family>
                    </name>
                  </assignedPerson>
                </assignedAuthor>
              </author>
              <!-- Immunization Administration Location -->
#*    *##if ( !$patient.getImmuExtValue("$immunization.getId()", "location").isEmpty() )
              <participant typeCode="LOC" contextControlCode="OP">
                <templateId root="2.16.840.1.113883.3.1818.10.4.13"/>
                <!-- Location Participation -->
                <participantRole classCode="SDLOC">
                  <playingEntity>
                    <name>$patient.getImmuExtValue("$immunization.getId()", "location")</name>
                  </playingEntity>
                </participantRole>
#*    *##else
              <participant nullFlavor="UNK" typeCode="LOC" contextControlCode="OP">
                <templateId root="2.16.840.1.113883.3.1818.10.4.13"/>
                <!-- Location Participation -->
                <participantRole nullFlavor="UNK" classCode="SDLOC"/>
#*    *##end
              </participant>
              <!-- Antigen Vaccine Type (PHAC Antigen code) -->
              <entryRelationship typeCode="COMP" contextConductionInd="true">
                <substanceAdministration classCode="SBADM" moodCode="EVN">
                  <code code="IMMUNIZ" codeSystem="2.16.840.1.113883.5.4" codeSystemName="HL7 ActCode"/>
                  <consumable typeCode="CSM">
                    <manufacturedProduct classCode="MANU">
                      <manufacturedMaterial classCode="MMAT" determinerCode="KIND">
                        <code nullFlavor="NI"/>
                        <name nullFlavor="NI"/>
                      </manufacturedMaterial>
                    </manufacturedProduct>
                  </consumable>
                </substanceAdministration>
              </entryRelationship>
#*    *##if ( !$patient.getImmuExtValue("$immunization.getId()", "comments").isEmpty() )
              <!-- Immunization Administration Comments -->
              <entryRelationship typeCode="SUBJ" contextConductionInd="true" inversionInd="true">
                <templateId root="2.16.840.1.113883.3.1818.10.4.3"/>
                <!-- Comment Observation -->
                <observation classCode="OBS" moodCode="EVN">
                  <code code="COMMENT" displayName="Comment Observation" codeSystem="2.16.840.1.113883.3.3068.10.6.3" codeSystemName="ObservationType-CA-Pending"/>
                  <text representation="TXT" mediaType="text/plain">$patient.cleanString($patient.getImmuExtValue("$immunization.getId()", "comments"))</text>
#*        *##if ( $immunization.getLastUpdateDate() )
                  <effectiveTime xsi:type="IVL_TS">
                    <low value="$dateTool.format('yyyyMMdd', $immunization.getLastUpdateDate())"/>
                  </effectiveTime>
#*        *##else
                  <effectiveTime nullFlavor"UNK"/>
#*        *##end
                  <value xsi:type="ST">$patient.getImmuExtValue("$immunization.getId()", "comments")</value>
                  <!-- Comment Author -->
                  <author typeCode="AUT" contextControlCode="OP">
                    <templateId root="2.16.840.1.113883.3.1818.10.4.2"/>
                    <!-- Author Participation -->
#*        *##if ( $immunization.getCreationDate() )
                    <time value="$dateTool.format('yyyyMMdd', $immunization.getCreationDate())"/>
#*        *##else
                    <time nullFlavor="UNK"/>
#*        *##end
                    <assignedAuthor classCode="ASSIGNED">
                      <id root="2.16.840.1.113883.3.40.2.11" extension="$patient.getProviderID($immunization.providerNo)" use="BUS"/>
                      <assignedPerson classCode="PSN" determinerCode="INSTANCE">
                        <name use="L">
                          <given>$patient.getProviderFirstName($immunization.providerNo)</given>
                          <family>$patient.getProviderLastName($immunization.providerNo)</family>
                        </name>
                      </assignedPerson>
                    </assignedAuthor>
                  </author>
                </observation>
              </entryRelationship>
#*    *##end
#*    *##if ( $immunizaton.getNextDate() )
              <!-- Next Immunization Date -->
              <entryRelationship typeCode="SUBJ" contextConductionInd="true">
                <templateId root="2.16.840.1.113883.3.1818.10.4.4"/>
                <!-- Date Observation -->
                <observation classCode="OBS" moodCode="EVN">
                  <code code="DATEOBS" displayName="Date Observation" codeSystem="2.16.840.1.113883.3.3068.10.6.3" codeSystemName="ObservationType-CA-Pending"/>
                  <effectiveTime xsi:type="IVL_TS">
                    <low value="$dateTool.format('yyyyMMdd', $immunizaton.getNextDate())"/>
                  </effectiveTime>
                </observation>
              </entryRelationship>
#*    *##end
#*    *##if ( ( $immunization.isRefused() || $immunization.isIneligible() ) && $patient.getImmuExtValue("$immunization.getId()", "neverReason") )
              <!-- Immunization or Refusal Reason -->
              <entryRelationship typeCode="SUBJ" contextConductionInd="true">
                <templateId root="2.16.840.1.113883.3.1818.10.4.24"/>
                <!-- Reason Observation -->
                <observation classCode="OBS" moodCode="EVN">
                  <code code="REASON" displayName="Reason Observation" codeSystem="2.16.840.1.113883.3.3068.10.6.3" codeSystemName="ObservationType-CA-Pending"/>
                  <text representation="TXT" mediaType="text/plain">$patient.cleanString($patient.getImmuExtValue("$immunization.getId()", "neverReason"))</text>
                  <value xsi:type="ST">$patient.getImmuExtValue("$immunization.getId()", "neverReason")</value>
                  <!-- Reason Author -->
                  <author typeCode="AUT" contextControlCode="OP">
                    <templateId root="2.16.840.1.113883.3.1818.10.4.2"/>
                    <!-- Author Participation -->
#*        *##if ( $immunization.getCreationDate() )
                    <time value="$dateTool.format('yyyyMMdd', $immunization.getCreationDate())"/>
#*        *##else
                    <time nullFlavor="UNK"/>
#*        *##end
                    <assignedAuthor classCode="ASSIGNED">
                      <id root="2.16.840.1.113883.3.40.2.11" extension="$patient.getProviderID($immunization.providerNo)" use="BUS"/>
                      <assignedPerson classCode="PSN" determinerCode="INSTANCE">
                        <name use="L">
                          <given>$patient.getProviderFirstName($immunization.providerNo)</given>
                          <family>$patient.getProviderLastName($immunization.providerNo)</family>
                        </name>
                      </assignedPerson>
                    </assignedAuthor>
                  </author>
                </observation>
              </entryRelationship>
#*    *##end
            </substanceAdministration>
          </entry>
#**##end
        </section>
      </component>
#else
      <component typeCode="COMP" contextConductionInd="true">
        <section classCode="DOCSECT" moodCode="EVN">
          <templateId root="2.16.840.1.113883.3.1818.10.2.14"/>
          <code code="11369-6" codeSystem="2.16.840.1.113883.6.1" codeSystemName="LOINC" displayName="History of Immunization"/>
          <title>Immunizations List [without entries]</title>
          <text mediaType="text/x-hl7-text+xml">$noInformation</text>
          <entry nullFlavor="NI" typeCode="DRIV" contextConductionInd="true">
            <templateId root="2.16.840.1.113883.3.1818.10.3.11"/>
            <substanceAdministration nullFlavor="NI" classCode="SBADM" moodCode="EVN">
              <id root="2.16.840.1.113883.3.3331" extension="Immunizations-0" assigningAuthorityName="OSCAR EMR"/>
              <code code="IMMUNIZ" codeSystem="2.16.840.1.113883.5.4" codeSystemName="HL7 ActCode"/>
              <effectiveTime nullFlavor="NI"/>
              <consumable typeCode="CSM">
                <manufacturedProduct classCode="MANU">
                  <manufacturedMaterial classCode="MMAT" determinerCode="KIND">
                    <code nullFlavor="NI"/>
                    <name nullFlavor="NI"/>
                  </manufacturedMaterial>
                </manufacturedProduct>
              </consumable>
              <author nullFlavor="UNK" typeCode="AUT" contextControlCode="OP">
                <time nullFlavor="UNK"/>
                <assignedAuthor classCode="ASSIGNED">
                  <id nullFlavor="UNK"/>
                  <assignedPerson classCode="PSN" determinerCode="INSTANCE">
                    <name nullFlavor="UNK"/>
                  </assignedPerson>
                </assignedAuthor>
              </author>
              <participant nullFlavor="UNK" typeCode="LOC" contextControlCode="OP">
                <templateId root="2.16.840.1.113883.3.1818.10.4.13"/>
                <participantRole nullFlavor="UNK" classCode="SDLOC"/>
              </participant>
              <entryRelationship typeCode="COMP" contextConductionInd="true">
                <substanceAdministration classCode="SBADM" moodCode="EVN">
                  <code code="ANTIGEN" codeSystem="2.16.840.1.113883.5.4" codeSystemName="HL7 ActCode"/>
                  <consumable typeCode="CSM">
                    <manufacturedProduct classCode="MANU">
                      <manufacturedMaterial classCode="MMAT" determinerCode="KIND">
                        <code nullFlavor="NI"/>
                        <name nullFlavor="NI"/>
                      </manufacturedMaterial>
                    </manufacturedProduct>
                  </consumable>
                </substanceAdministration>
              </entryRelationship>
            </substanceAdministration>
          </entry>
        </section>
      </component>
#end
<!--
********************************************************
Laboratory Results & Results
********************************************************
-->
#if ( $patient.hasLabs() )
      <component typeCode="COMP" contextConductionInd="true">
        <section classCode="DOCSECT" moodCode="EVN">
          <templateId root="2.16.840.1.113883.3.1818.10.2.16.1"/>
          <code code="30954-2" codeSystem="2.16.840.1.113883.6.1" codeSystemName="LOINC" displayName="Relevant Diagnostic Tests and/or Laboratory Data"/>
          <title>Laboratory Results and Reports [with entries]</title>
          <text mediaType="text/x-hl7-text+xml">
#**##foreach( $lab in $patient.getLabs() )
#*    *##foreach( $labGroup in $lab.getGroup() )
            <list>
              <item>$!patient.cleanString($!lab.hl7TextInfo.discipline)  $!dateTool.format('MMM dd, yyyy', $patient.stringToDate($lab.hl7TextInfo.getObrDate()))</item>
#*        *##foreach( $labEntry in $labGroup.getMeasurement() )
#*            *##if ( !$patient.getLabExtValue("$labEntry.id", "unit").isEmpty() )
              <item>$!patient.getLabExtValue("$labEntry.id", "name"): $!patient.cleanString($labEntry.dataField) $!patient.getLabExtValue("$labEntry.id", "unit")</item>
#*            *##else
              <item>$!patient.getLabExtValue("$labEntry.id", "name"): $!patient.cleanString($labEntry.dataField)</item>
#*            *##end
#*        *##end
            </list>
#*    *##end
#**##end
          </text>
#**##foreach( $lab in $patient.getLabs() )
          <entry typeCode="DRIV" contextConductionInd="true">
            <templateId root="2.16.840.1.113883.3.1818.10.2.16.1"/>
            <!-- Laboratory Observation -->
            <observation classCode="OBS" moodCode="EVN">
              <id root="2.16.840.1.113883.3.3331" extension="Lab-$lab.hl7TextInfo.id"/>
              <code nullFlavor='NA'/>
#*    *##if ( !$stringUtils.isNullOrEmpty($lab.hl7TextInfo.discipline) )
              <text representation="TXT" mediaType="text/plain">$patient.cleanString($lab.hl7TextInfo.discipline)</text>
#*    *##end
              <!-- Ordering Provider -->
              <author typeCode="AUT" contextControlCode="OP">
                <templateId root="2.16.840.1.113883.3.1818.10.4.2"/>
                <!-- Author Participation -->
#*    *##if ( !$stringUtils.isNullOrEmpty($lab.hl7TextInfo.getObrDate()) )
                <time value="$dateTool.format('yyyyMMdd', $patient.stringToDate($lab.hl7TextInfo.getObrDate()))"/>
#*    *##else
                <time nullFlavor="UNK"/>
#*    *##end
                <assignedAuthor classCode="ASSIGNED">
                  <id nullFlavor="UNK"/>
                  <assignedPerson classCode="PSN" determinerCode="INSTANCE">
                    <name>$patient.cleanString($lab.hl7TextInfo.requestingProvider)</name>
                  </assignedPerson>
                </assignedAuthor>
              </author>
#*    *##foreach( $labGroup in $lab.getGroup() )
              <entryRelationship typeCode="COMP" contextConductionInd="true">
                <templateId root="2.16.840.1.113883.3.1818.10.4.26"/>
                <!-- Result Organizer -->
                <organizer classCode="BATTERY" moodCode="EVN">
                  <templateId root="2.16.840.1.113883.3.1818.10.4.26"/>
                  <id root="2.16.840.1.113883.3.3331" extension="LabOBR-$labGroup.groupId"/>
                  <code nullFlavor='UNK'/>
## This status code comes from entire lab report - doesn't represent just this battery group
#*        *##if ( $lab.hl7TextInfo.reportStatus == "P" )
                  <statusCode code="active"/>
#*        *##else
                  <statusCode code="complete"/>
#*        *##end
#*        *##foreach( $labEntry in $labGroup.getMeasurement() )
                  <component typeCode="COMP" contextConductionInd="true">
                    <templateId root="2.16.840.1.113883.3.1818.10.4.25"/>
                    <!-- Result Component -->
                    <observation classCode="OBS" moodCode="EVN">
#*            *##if ( !$patient.getLabExtValue("$labEntry.id", "accession").isEmpty() )
                      <id root="2.16.840.1.113883.3.1818.10.2.10.33" extension="$patient.getLabExtValue("$labEntry.id", "accession")"/>
#*            *##else
                      <id nullFlavor='UNK'/>
#*            *##end
#*            *##if ( !$patient.getLabExtValue("$labEntry.id", "identifier").isEmpty() )
                      <code code="$patient.cleanString($patient.getLabExtValue("$labEntry.id", "identifier"))" displayName="$patient.getLabExtValue("$labEntry.id", "name")" codeSystem="2.16.840.1.113883.2.20.5.1" codeSystemName="pCLOCD"/>
#*            *##else
                      <code nullFlavor='UNK'/>
#*            *##end
#*            *##if ( !$patient.getLabExtValue("$labEntry.id", "name").isEmpty() )
                      <text representation="TXT" mediaType="text/plain">$patient.cleanString($patient.getLabExtValue("$labEntry.id", "name"))</text>
#*            *##end
#*            *##if ( $patient.getLabExtValue("$labEntry.id", "olis_status") == "P" )
                      <statusCode code="active"/>
#*            *##else
                      <statusCode code="complete"/>
#*            *##end
#*            *##if ( !$stringUtils.isNullOrEmpty($patient.getLabExtValue("$labEntry.id", "datetime")) )
                      <effectiveTime xsi:type="IVL_TS">
                        <low value="$dateTool.format('yyyyMMddHHmmss', $patient.stringToDate($patient.getLabExtValue("$labEntry.id", "datetime")))"/>
                      </effectiveTime>
#*            *##else
                      <effectiveTime nullFlavor="UNK"/>
#*            *##end
#*            *##if ( !$stringUtils.isNullOrEmpty($labEntry.dataField) )
#*                *##if ( !$patient.getLabExtValue("$labEntry.id", "unit").isEmpty() )
#*                    *##if ( $stringUtils.isNumeric($labEntry.dataField) )
                      <value xsi:type="PQ" value="$patient.cleanString($labEntry.dataField)" unit="$patient.getLabExtValue("$labEntry.id", "unit").replaceAll("\s","_")"/>
#*                    *##else
                      <value xsi:type="ST">$patient.cleanString($labEntry.dataField) $patient.getLabExtValue("$labEntry.id", "unit")</value>
#*                    *##end
#*                *##else
                      <value xsi:type="ST">$patient.cleanString($labEntry.dataField)</value>
#*                *##end
#*            *##else
                      <value xsi:type="ST" nullFlavor="NI"/>
#*            *##end
#*            *##if ( !$patient.getLabExtValue("$labEntry.id", "abnormal").isEmpty() )
#*                *##if ( $patient.getLabExtValue("$labEntry.id", "abnormal") == "A" )
                      <interpretationCode code="A" displayName="Abnormal" codeSystem="2.16.840.1.113883.2.20.3.78" codeSystemName="ObservationInterpretation"/>
#*                *##else
                      <interpretationCode code="N" displayName="Normal" codeSystem="2.16.840.1.113883.2.20.3.78" codeSystemName="ObservationInterpretation"/>
#*                *##end
#*            *##end
#*            *##if ( !$patient.getLabExtValue("$labEntry.id", "labname").isEmpty() )
                      <!-- Resulting Organization -->
                      <performer typeCode="PRF">
                        <templateId root="2.16.840.1.113883.3.1818.10.4.19"/>
                        <!-- Performer Participation -->
#*                *##if ( !$stringUtils.isNullOrEmpty($patient.getLabExtValue("$labEntry.id", "datetime")) )
                        <time value="$dateTool.format('yyyyMMddHHmmss', $patient.stringToDate($patient.getLabExtValue("$labEntry.id", "datetime")))"/>
#*                *##else
                        <time nullFlavor="UNK"/>
#*                *##end
                        <assignedEntity>
                          <id nullFlavor="NI"/>
                          <representedOrganization classCode="ORG" determinerCode="INSTANCE">
                            <name>$patient.getLabExtValue("$labEntry.id", "labname")</name>
                          </representedOrganization>
                        </assignedEntity>
                      </performer>
#*            *##end
                      <!--Specimen Collection Information -->
                      <entryRelationship typeCode="COMP">
                        <procedure classCode="PROC" moodCode="EVN">
                          <!-- specimen collection date -->
#*            *##if ( $lab.hl7TextInfo.getObrDate() && !$lab.hl7TextInfo.getObrDate().isEmpty() )
                          <effectiveTime value="$dateTool.format('yyyyMMddHHmmss', $patient.stringToDate($lab.hl7TextInfo.getObrDate()))"/>
#*            *##else
                          <effectiveTime nullFlavor="UNK"/>
#*            *##end
                        </procedure>
                      </entryRelationship>
#*            *##if ( !$stringUtils.isNullOrEmpty($labEntry.comments) )
                      <!-- Result Notes -->
                      <entryRelationship typeCode="SUBJ" contextConductionInd="true" inversionInd="true">
                        <templateId root="2.16.840.1.113883.3.1818.10.4.3"/>
                        <!-- Comment Observation -->
                        <observation classCode="OBS" moodCode="EVN">
                          <code code="COMMENT" displayName="Comment Observation" codeSystem="2.16.840.1.113883.3.3068.10.6.3" codeSystemName="ObservationType-CA-Pending"/>
                          <value xsi:type="ST">$labEntry.comments</value>
                        </observation>
                      </entryRelationship>
#*            *##end
## Range is more general than Minimum/Maximum - OSCAR only populates Range if it can't determine a min/max
#*            *##if ( !$patient.getLabExtValue("$labEntry.id", "range").isEmpty() )
                      <referenceRange typeCode="REFV">
                        <observationRange classCode="OBS" moodCode="EVN.CRT">
                          <code code="N" displayName="Normal" codeSystem="2.16.840.1.113883.1.11.10206" codeSystemName="ObservationInterpretationNormality"/>
                          <text representation="TXT" mediaType="text/plain">$patient.cleanString($patient.getLabExtValue("$labEntry.id", "range"))</text>
                          <value xsi:type="ST">$patient.cleanString($patient.getLabExtValue("$labEntry.id", "range"))</value>
                        </observationRange>
                      </referenceRange>
#*            *##elseif ( !$patient.getLabExtValue("$labEntry.id", "minimum").isEmpty() || !$patient.getLabExtValue("$labEntry.id", "maximum").isEmpty() )
                      <referenceRange typeCode="REFV">
                        <observationRange classCode="OBS" moodCode="EVN.CRT">
                          <code code="N" displayName="Normal" codeSystem="2.16.840.1.113883.1.11.10206" codeSystemName="ObservationInterpretationNormality"/>
#*                *##if ( $patient.getLabExtValue("$labEntry.id", "minimum").isEmpty() )
                          <text representation="TXT" mediaType="text/plain">Normal Reference range is less than $!patient.getLabExtValue("$labEntry.id", "maximum")</text>
#*                *##elseif ( $patient.getLabExtValue("$labEntry.id", "maximum").isEmpty() )
                          <text representation="TXT" mediaType="text/plain">Normal Reference range is greater than $!patient.getLabExtValue("$labEntry.id", "minimum")</text>
#*                *##else
                          <text representation="TXT" mediaType="text/plain">Normal Reference range is between $!patient.getLabExtValue("$labEntry.id", "minimum") and $!patient.getLabExtValue("$labEntry.id", "maximum")</text>
#*                *##end
                          <value xsi:type="IVL_REAL">
#*                *##if ( !$patient.getLabExtValue("$labEntry.id", "minimum").isEmpty() )
                            <low value="$patient.getLabExtValue("$labEntry.id", "minimum")"/> 
#*                *##end
#*                *##if ( !$patient.getLabExtValue("$labEntry.id", "maximum").isEmpty() )
                            <high value="$patient.getLabExtValue("$labEntry.id", "maximum")"/> 
#*                *##end
                          </value>
                        </observationRange>
                      </referenceRange>
#*            *##else
#*            *##end
                    </observation>
                  </component>
#*        *##end
                </organizer>
              </entryRelationship>
#*    *##end
            </observation>
          </entry>
#**##end
        </section>
      </component>
#else
      <component typeCode="COMP" contextConductionInd="true">
        <section classCode="DOCSECT" moodCode="EVN">
          <templateId root="2.16.840.1.113883.3.1818.10.2.16"/>
          <code code="11502-2" codeSystem="2.16.840.1.113883.6.1" codeSystemName="LOINC" displayName="Relevant Diagnostic Tests and/or Laboratory Data"/>
          <title>Laboratory Results and Reports [without entries]</title>
          <text mediaType="text/x-hl7-text+xml">$noInformation</text>
          <entry nullFlavor="NI" typeCode="DRIV" contextConductionInd="true">
            <templateId root="2.16.840.1.113883.3.1818.10.3.12"/>
            <observation nullFlavor="NI" classCode="OBS" moodCode="EVN">
              <id root="2.16.840.1.113883.3.3331" extension="Lab-0" assigningAuthorityName="OSCAR EMR"/>
              <code nullFlavor="NA"/>
              <entryRelationship typeCode="COMP" contextConductionInd="true">
                <templateId root="2.16.840.1.113883.3.1818.10.4.26"/>
                <organizer classCode="BATTERY" moodCode="EVN">
                  <templateId root="2.16.840.1.113883.3.1818.10.4.26"/>
                  <code nullFlavor="NA"/>
                  <statusCode nullFlavor="NA"/>
                  <component nullFlavor="NI" typeCode="COMP" contextConductionInd="true">
                    <templateId root="2.16.840.1.113883.3.1818.10.4.25"/>
                    <observation nullFlavor="NI" classCode="OBS" moodCode="EVN">
                      <id nullFlavor="NI"/>
                      <code nullFlavor="NI"/>
                      <statusCode nullFlavor="NI"/>
                      <entryRelationship nullFlavor="NI" typeCode="COMP" contextConductionInd="true">
                        <procedure nullFlavor="NI" classCode="PROC" moodCode="EVN">
                          <effectiveTime nullFlavor="NI"/>
                        </procedure>
                      </entryRelationship>
                    </observation>
                  </component>
                </organizer>
              </entryRelationship>
            </observation>
          </entry>
        </section>
      </component>
#end
<!--
********************************************************
Medications and Prescriptions - Medication List
********************************************************
-->
#if ( $patient.hasMedications() )
      <component typeCode="COMP" contextConductionInd="true">
        <section classCode="DOCSECT" moodCode="EVN">
          <templateId root="2.16.840.1.113883.3.1818.10.2.19.1"/>
          <code code="10160-0" codeSystem="2.16.840.1.113883.6.1" codeSystemName="LOINC" displayName="History of Medication Use"/>
          <title>Medications and Prescriptions - Medication List [with entries]</title>
          <text mediaType="text/x-hl7-text+xml">
            <list>
#**##set( $previousDin = "0" )
#**##set( $currentDin = "0" )
#**##foreach ( $med in $patient.getMedications() )
#*    *##if( $stringUtils.isNullOrEmpty($med.regionalIdentifier) )
#*        *##set( $currentDin = "null" )
#*    *##else
#*        *##set( $currentDin = $med.regionalIdentifier )
#*    *##end
#*    *##if( !$previousDin.equals($currentDin) || $currentDin.equals("null") )
#*        *##if ( $med.brandName )
              <item>$!med.brandName $!med.freqCode $!med.duration $!med.durUnit</item>
#*        *##else
              <item>$!med.genericName $!med.dosage $!med.freqCode $!med.duration $!med.durUnit</item>
#*        *##end
#*    *##end
#*    *##set( $previousDin = $currentDin )
#**##end
            </list>
          </text>
#**##set( $previousDin = "0" )
#**##set( $currentDin = "0" )
#**##foreach ( $med in $patient.getMedications() )
#*    *##if( $stringUtils.isNullOrEmpty($med.regionalIdentifier) )
#*        *##set( $currentDin = "null" )
#*    *##else
#*        *##set( $currentDin = $med.regionalIdentifier )
#*    *##end
#*    *##if( !$previousDin.equals("0") && ( !$previousDin.equals($currentDin) || $currentDin.equals("null") ) )
            </substanceAdministration>
          </entry>
#*    *##end
#*    *##if( !$previousDin.equals($currentDin) || $currentDin.equals("null") )
          <entry typeCode="DRIV" contextConductionInd="true">
            <templateId root="2.16.840.1.113883.3.1818.10.3.18"/>
            <substanceAdministration classCode="SBADM" moodCode="EVN">
              <id root="2.16.840.1.113883.3.1818.10.10.3" extension="Medications-$med.id" assigningAuthorityName="OSCAR EMR"/>
              <code code="DRUG" displayName="Drug Therapy" codeSystem="2.16.840.1.113883.5.4" codeSystemName="HL7 ActCode"/>
#*        *##if ( $med.longTerm || $patient.isActiveDrug($med.getEndDate()) )
              <statusCode code="active"/>
#*        *##else
              <statusCode code="completed"/>
#*        *##end
              <!-- Medication -->
              <consumable typeCode="CSM">
                <templateId root="2.16.840.1.113883.3.1818.10.4.16"/>
                <!-- Medication Identification -->
                <manufacturedProduct classCode="MANU">
                  <manufacturedLabeledDrug classCode="MMAT" determinerCode="KIND">
#*        *##if ( !$stringUtils.isNullOrEmpty($med.regionalIdentifier) )
#*            *##if ( !$stringUtils.isNullOrEmpty($med.genericName) )
                    <code code="$med.regionalIdentifier" codeSystem="2.16.840.1.113883.5.1105" codeSystemName="HC-DIN" displayName="$med.genericName"/>
#*            *##else
                    <code code="$med.regionalIdentifier" codeSystem="2.16.840.1.113883.5.1105" codeSystemName="HC-DIN"/>
#*            *##end
#*        *##end
#*        *##if ( !$stringUtils.isNullOrEmpty($med.atc) )
#*            *##if ( !$stringUtils.isNullOrEmpty($med.genericName) )
                    <code code="$med.atc" codeSystem="2.16.840.1.113883.6.73" codeSystemName="whoATC" displayName="$med.genericName"/>
#*            *##else
                    <code code="$med.atc" codeSystem="2.16.840.1.113883.6.73" codeSystemName="whoATC"/>
#*            *##end
#*        *##end
#*        *##if ( $stringUtils.isNullOrEmpty($med.regionalIdentifier) && $stringUtils.isNullOrEmpty($med.atc) )
                    <code nullFlavor="NI"/>
#*        *##end
#*        *##if ( !$stringUtils.isNullOrEmpty($med.genericName) )
                    <name>$med.genericName</name>
#*        *##elseif ( !$stringUtils.isNullOrEmpty($med.brandName) )
                    <name>$med.brandName</name>
#*        *##else
                    <name nullFlavor="NI"/>
#*        *##end
#*        *##if ( !$stringUtils.isNullOrEmpty($med.brandName) )
                    <e2e:desc>$med.brandName</e2e:desc>
#*        *##end
#*        *##if( $e2e.formCodeMap($med.drugForm) )
                    <e2e:formCode code="$e2e.formCodeMap($med.drugForm)" displayName="$med.drugForm" codeSystem="2.16.840.1.113883.19.5.3" codeSystemName="HL7 Orderable Drug Form"/>
#*        *##elseif ( !$stringUtils.isNullOrEmpty($med.drugForm) )
                    <e2e:formCode code="TBD" displayName="$med.drugForm" codeSystem="2.16.840.1.113883.19.5.3" codeSystemName="HL7 Orderable Drug Form"/>
#*        *##end
#*        *##if ( ( !$stringUtils.isNullOrEmpty($med.dosage) && !$stringUtils.isNullOrEmpty($med.unit) ) || !$stringUtils.isNullOrEmpty($med.genericName) )
                    <e2e:ingredient classCode="INGR">
#*            *##if ( !$stringUtils.isNullOrEmpty($med.dosage) && !$stringUtils.isNullOrEmpty($med.unit) )
                      <e2e:quantity value="$med.dosage.trim().replaceAll(" .*", "")" unit="$med.unit"/>
#*            *##end
#*            *##if ( !$stringUtils.isNullOrEmpty($med.genericName) )
                      <e2e:ingredient classCode="MMAT" determinerCode="KIND">
                        <e2e:code code="TBD" displayName="$med.genericName" codeSystem="TBD" codeSystemName="ClinicalDrug"/>
                        <e2e:name>$med.genericName</e2e:name>
                      </e2e:ingredient>
#*            *##else
                      <e2e:ingredient nullFlavor="NI"/>
#*            *##end
                    </e2e:ingredient>
#*        *##end
                  </manufacturedLabeledDrug>
                </manufacturedProduct>
              </consumable>
              <!-- Record Type -->
              <entryRelationship typeCode="COMP" contextConductionInd="true">
                <templateId root="2.16.840.1.113883.3.1818.10.4.32"/>
                <!-- Unbounded Observation -->
                <observation classCode="OBS" moodCode="EVN">
                  <code code="UNBOUND" displayName="Unbound Observation" codeSystem="2.16.840.1.113883.3.3068.10.6.3" codeSystemName="ObservationType-CA-Pending"/>
#*        *##if ( $med.longTerm )
                  <text representation="TXT" mediaType="text/plain">Long Term</text>
#*        *##else
                  <text representation="TXT" mediaType="text/plain">Short Term</text>
#*        *##end
                </observation>
              </entryRelationship>
#*        *##if ( $med.getLastUpdateDate() )
              <!-- Last Review Date -->
              <entryRelationship typeCode="SUBJ" contextConductionInd="true" inversionInd="true">
                <templateId root="2.16.840.1.113883.3.1818.10.4.4"/>
                <!-- Date Observation -->
                <observation classCode="OBS" moodCode="EVN">
                  <code code="DATEOBS" displayName="Date Observation" codeSystem="2.16.840.1.113883.3.3068.10.6.3" codeSystemName="ObservationType-CA-Pending"/>
                  <effectiveTime xsi:type="IVL_TS">
                    <low value="$dateTool.format('yyyyMMdd', $med.getLastUpdateDate())"/>
                  </effectiveTime>
                </observation>
              </entryRelationship>
#*        *##end
#*    *##end
              <!-- Prescription Information -->
              <entryRelationship typeCode="COMP" contextConductionInd="true">
                <templateId root="2.16.840.1.113883.3.1818.10.4.20"/>
                <!-- Medication Prescription Event-->
                <substanceAdministration classCode="SBADM" moodCode="RQO">
                  <id root="2.16.840.1.113883.3.3331" extension="MedicationPrescriptions-$med.id" assigningAuthorityName="OSCAR EMR"/>
                  <code code="DRUG" codeSystem="2.16.840.1.113883.5.4" displayName="Drug Therapy"/>
                  <!-- Start/Stop Date -->
                  <effectiveTime xsi:type="IVL_TS" operator="I">
#*    *##if ( $med.getRxDate() )
                    <low value="$dateTool.format('yyyyMMdd', $med.getRxDate())"/>
#*    *##else
                    <low nullFlavor="UNK"/>
#*    *##end
#*    *##if ( $med.getEndDate() )
                    <high value="$dateTool.format('yyyyMMdd', $med.getEndDate())"/>
#*    *##end
                  </effectiveTime>
                  <consumable typeCode="CSM">
                    <templateId root="2.16.840.1.113883.3.1818.10.4.16"/>
                    <!-- Medication Identification -->
                    <manufacturedProduct classCode="MANU">
                      <manufacturedLabeledDrug classCode="MMAT" determinerCode="KIND">
#*    *##if ( !$stringUtils.isNullOrEmpty($med.regionalIdentifier) )
#*        *##if ( !$stringUtils.isNullOrEmpty($med.genericName) )
                        <code code="$med.regionalIdentifier" codeSystem="2.16.840.1.113883.5.1105" codeSystemName="HC-DIN" displayName="$med.genericName"/>
#*        *##else
                        <code code="$med.regionalIdentifier" codeSystem="2.16.840.1.113883.5.1105" codeSystemName="HC-DIN"/>
#*        *##end
#*    *##end
#*    *##if ( !$stringUtils.isNullOrEmpty($med.atc) )
#*        *##if ( !$stringUtils.isNullOrEmpty($med.genericName) )
                        <code code="$med.atc" codeSystem="2.16.840.1.113883.6.73" codeSystemName="whoATC" displayName="$med.genericName"/>
#*        *##else
                        <code code="$med.atc" codeSystem="2.16.840.1.113883.6.73" codeSystemName="whoATC"/>
#*        *##end
#*    *##end
#*    *##if ( $stringUtils.isNullOrEmpty($med.regionalIdentifier) && $stringUtils.isNullOrEmpty($med.atc) )
                        <code nullFlavor="NI"/>
#*    *##end
#*    *##if ( !$stringUtils.isNullOrEmpty($med.genericName) )
                        <name>$med.genericName</name>
#*    *##elseif ( !$stringUtils.isNullOrEmpty($med.brandName) )
                        <name>$med.brandName</name>
#*    *##else
                        <name nullFlavor="NI"/>
#*    *##end
#*    *##if ( !$stringUtils.isNullOrEmpty($med.brandName) )
                        <e2e:desc>$med.brandName</e2e:desc>
#*    *##end
#*    *##if( $e2e.formCodeMap($med.drugForm) )
                        <e2e:formCode code="$e2e.formCodeMap($med.drugForm)" displayName="$med.drugForm" codeSystem="2.16.840.1.113883.19.5.3" codeSystemName="HL7 Orderable Drug Form"/>
#*    *##elseif ( !$stringUtils.isNullOrEmpty($med.drugForm) )
                        <e2e:formCode code="TBD" displayName="$med.drugForm" codeSystem="2.16.840.1.113883.19.5.3" codeSystemName="HL7 Orderable Drug Form"/>
#*    *##end
#*    *##if ( ( !$stringUtils.isNullOrEmpty($med.dosage) && !$stringUtils.isNullOrEmpty($med.unit) ) || !$stringUtils.isNullOrEmpty($med.genericName) )
                        <e2e:ingredient classCode="INGR">
#*        *##if ( !$stringUtils.isNullOrEmpty($med.dosage) && !$stringUtils.isNullOrEmpty($med.unit) )
                          <e2e:quantity value="$med.dosage.trim().replaceAll(" .*", "")" unit="$med.unit"/>
#*        *##end
#*        *##if ( !$stringUtils.isNullOrEmpty($med.genericName) )
                          <e2e:ingredient classCode="MMAT" determinerCode="KIND">
                            <e2e:code code="TBD" displayName="$med.genericName" codeSystem="TBD" codeSystemName="ClinicalDrug"/>
                            <e2e:name>$med.genericName</e2e:name>
                          </e2e:ingredient>
#*        *##else
                          <e2e:ingredient nullFlavor="NI"/>
#*        *##end
                        </e2e:ingredient>
#*    *##end
                      </manufacturedLabeledDrug>
                    </manufacturedProduct>
                  </consumable>
                  <!-- Prescribing Provider -->
                  <author typeCode="AUT" contextControlCode="OP">
                    <templateId root="2.16.840.1.113883.3.1818.10.4.2"/>
                    <!-- Author Participation -->
#*    *##if ( $med.getWrittenDate() )
                    <time value="$dateTool.format('yyyyMMdd', $med.getWrittenDate())"/>
#*    *##else
                    <time nullFlavor="UNK"/>
#*    *##end
                    <assignedAuthor classCode="ASSIGNED">
#*    *##if ( $med.isExternal() )
#*        *##if ( !$stringUtils.isNullOrEmpty($med.outsideProviderOhip) )
                      <id root="2.16.840.1.113883.3.40.2.11" extension="$med.outsideProviderOhip" use="BUS"/>
#*        *##else
                      <id nullFlavor="NI"/>
#*        *##end
                      <assignedPerson classCode="PSN" determinerCode="INSTANCE">
#*        *##if ( !$stringUtils.isNullOrEmpty($med.outsideProviderName) )
                        <name use="L">$med.outsideProviderName</name>
#*        *##else
                        <name nullFlavor="NI"/>
#*        *##end
#*    *##else
                      <id root="2.16.840.1.113883.3.40.2.11" extension="$patient.getProviderID($med.providerNo)" use="BUS"/>
                      <assignedPerson classCode="PSN" determinerCode="INSTANCE">
                        <name use="L">
                          <given>$patient.getProviderFirstName($med.providerNo)</given>
                          <family>$patient.getProviderLastName($med.providerNo)</family>
                        </name>
#*    *##end
                      </assignedPerson>
                    </assignedAuthor>
                  </author>
                  <entryRelationship typeCode="COMP" contextConductionInd="true">
                    <templateId root="2.16.840.1.113883.3.1818.10.4.8"/>
                    <!-- Dose Observation -->
                    <substanceAdministration classCode="SBADM" moodCode="RQO">
#*    *##if ( $stringUtils.isNumeric($med.duration) && $med.duration != "0" && $med.durUnit )
                      <!-- Duration -->
                      <text representation="TXT" mediaType="text/plain">$!med.duration $!med.durUnit</text>
#*    *##end
                      <!-- Frequency -->
                      <!-- OSCAR Frequency Code $!med.freqCode -->
#*    *##if ( $med.freqCode.equalsIgnoreCase("BID") || $med.freqCode.equalsIgnoreCase("twice daily") )
                      <effectiveTime xsi:type="PIVL_TS" institutionSpecified="true">
                        <frequency>
                          <numerator value="2"/>
                          <denominator value="1" unit="d"/>
                        </frequency>
                      </effectiveTime>
#*    *##elseif ( $med.freqCode.equalsIgnoreCase("TID") || $med.freqCode.equalsIgnoreCase("3x day") || $med.freqCode.equalsIgnoreCase("3x daily"))
                      <effectiveTime xsi:type="PIVL_TS" institutionSpecified="true">
                        <frequency>
                          <numerator value="3"/>
                          <denominator value="1" unit="d"/>
                        </frequency>
                      </effectiveTime>
#*    *##elseif ( $med.freqCode.equalsIgnoreCase("QID") || $med.freqCode.equalsIgnoreCase("4x day") || $med.freqCode.equalsIgnoreCase("4x daily"))
                      <effectiveTime xsi:type="PIVL_TS" institutionSpecified="true">
                        <frequency>
                          <numerator value="4"/>
                          <denominator value="1" unit="d"/>
                        </frequency>
                      </effectiveTime>
#*    *##elseif ( $med.freqCode.equalsIgnoreCase("Q1H") )
                      <effectiveTime xsi:type="PIVL_TS" institutionSpecified="true">
                        <frequency>
                          <numerator value="1"/>
                          <denominator value="1" unit="h"/>
                        </frequency>
                      </effectiveTime>
#*    *##elseif ( $med.freqCode.equalsIgnoreCase("Q1-2H") )
                      <effectiveTime xsi:type="PIVL_TS" institutionSpecified="true">
                        <period xsi:type="URG_PQ">
                          <low value="1" unit="h"/>
                          <high value="2" unit="h"/>
                        </period>
                      </effectiveTime>
#*    *##elseif ( $med.freqCode.equalsIgnoreCase("Q2H") )
                      <effectiveTime xsi:type="PIVL_TS" institutionSpecified="true">
                        <frequency>
                          <numerator value="1"/>
                          <denominator value="2" unit="h"/>
                        </frequency>
                      </effectiveTime>
#*    *##elseif ( $med.freqCode.equalsIgnoreCase("Q3-4H") )
                      <effectiveTime xsi:type="PIVL_TS" institutionSpecified="true">
                        <period xsi:type="URG_PQ">
                          <low value="3" unit="h"/>
                          <high value="4" unit="h"/>
                        </period>
                      </effectiveTime>
#*    *##elseif ( $med.freqCode.equalsIgnoreCase("Q4H") )
                      <effectiveTime xsi:type="PIVL_TS" institutionSpecified="true">
                        <frequency>
                          <numerator value="1"/>
                          <denominator value="4" unit="h"/>
                        </frequency>
                      </effectiveTime>
#*    *##elseif ( $med.freqCode.equalsIgnoreCase("Q4-6H") )
                      <effectiveTime xsi:type="PIVL_TS" institutionSpecified="true">
                        <period xsi:type="URG_PQ">
                          <low value="4" unit="h"/>
                          <high value="6" unit="h"/>
                        </period>
                      </effectiveTime>
#*    *##elseif ( $med.freqCode.equalsIgnoreCase("Q6H") )
                      <effectiveTime xsi:type="PIVL_TS" institutionSpecified="true">
                        <frequency>
                          <numerator value="1"/>
                          <denominator value="6" unit="h"/>
                        </frequency>
                      </effectiveTime>
#*    *##elseif ( $med.freqCode.equalsIgnoreCase("Q8H") )
                      <effectiveTime xsi:type="PIVL_TS" institutionSpecified="true">
                        <frequency>
                          <numerator value="1"/>
                          <denominator value="8" unit="h"/>
                        </frequency>
                      </effectiveTime>
#*    *##elseif ( $med.freqCode.equalsIgnoreCase("Q12H") )
                      <effectiveTime xsi:type="PIVL_TS" institutionSpecified="true">
                        <frequency>
                          <numerator value="1"/>
                          <denominator value="12" unit="h"/>
                        </frequency>
                      </effectiveTime>
#*    *##elseif ( $med.freqCode.equalsIgnoreCase("QAM") || $med.freqCode.equalsIgnoreCase("QPM") || $med.freqCode.equalsIgnoreCase("QHS") || $med.freqCode.equalsIgnoreCase("daily") || $med.freqCode.equalsIgnoreCase("once daily") || $med.freqCode.equalsIgnoreCase("OD") )
                      <effectiveTime xsi:type="PIVL_TS" institutionSpecified="true">
                        <frequency>
                          <numerator value="1"/>
                          <denominator value="1" unit="d"/>
                        </frequency>
                      </effectiveTime>
#*    *##elseif ( $med.freqCode.equalsIgnoreCase("weekly") || $med.freqCode.equalsIgnoreCase("Q1Week") )
                      <effectiveTime xsi:type="PIVL_TS" institutionSpecified="true">
                        <frequency>
                          <numerator value="1"/>
                          <denominator value="1" unit="w"/>
                        </frequency>
                      </effectiveTime>
#*    *##elseif ( $med.freqCode.equalsIgnoreCase("Q2Week") )
                      <effectiveTime xsi:type="PIVL_TS" institutionSpecified="true">
                        <frequency>
                          <numerator value="1"/>
                          <denominator value="2" unit="w"/>
                        </frequency>
                      </effectiveTime>
#*    *##elseif ( $med.freqCode.equalsIgnoreCase("Q1Month") || $med.freqCode.equalsIgnoreCase("monthly") )
                      <effectiveTime xsi:type="PIVL_TS" institutionSpecified="true">
                        <frequency>
                          <numerator value="1"/>
                          <denominator value="1" unit="m"/>
                        </frequency>
                      </effectiveTime>
#*    *##elseif ( $med.freqCode.equalsIgnoreCase("Q3Month") )
                      <effectiveTime xsi:type="PIVL_TS" institutionSpecified="true">
                        <frequency>
                          <numerator value="1"/>
                          <denominator value="3" unit="m"/>
                        </frequency>
                      </effectiveTime>
#*    *##else
                      <effectiveTime nullFlavor="NI"/>
#*    *##end
                      <!-- Route -->
#*    *##if ( !$stringUtils.isNullOrEmpty($med.route) )
                      <routeCode code="$med.route" displayName="$med.route" codeSystem="2.16.840.1.113883.5.112" codeSystemName="RouteOfAdministration"/>
#*    *##end
                      <!-- Dose -->
                      <doseQuantity>
## OSCAR stores min/max number by pill/unit count, not milligrams
#*    *##if( !$stringUtils.isNullOrEmpty($med.unitName) )
                        <low value="$med.takeMin" unit="$med.unitName.replaceAll("\s","_")"/>
                        <high value="$med.takeMax" unit="$med.unitName.replaceAll("\s","_")"/>
#*    *##else
                        <low value="$med.takeMin"/>
                        <high value="$med.takeMax"/>
#*    *##end
                      </doseQuantity>
                      <!-- Form -->
#*    *##if( $e2e.formCodeMap($med.drugForm) )
                      <administrationUnitCode code="$e2e.formCodeMap($med.drugForm)" displayName="$med.drugForm" codeSystem="2.16.840.1.113883.1.11.14570" codeSystemName="AdministerableDrugForm"/>
#*    *##else
                      <!-- OSCAR Form Code $!med.drugForm -->
#*    *##end
                      <consumable typeCode="CSM">
                        <templateId root="2.16.840.1.113883.3.1818.10.4.16"/>
                        <!-- Medication Identification -->
                        <manufacturedProduct classCode="MANU">
                          <manufacturedLabeledDrug classCode="MMAT" determinerCode="KIND">
#*    *##if ( !$stringUtils.isNullOrEmpty($med.regionalIdentifier) )
#*        *##if ( !$stringUtils.isNullOrEmpty($med.genericName) )
                            <code code="$med.regionalIdentifier" codeSystem="2.16.840.1.113883.5.1105" codeSystemName="HC-DIN" displayName="$med.genericName"/>
#*        *##else
                            <code code="$med.regionalIdentifier" codeSystem="2.16.840.1.113883.5.1105" codeSystemName="HC-DIN"/>
#*        *##end
#*    *##end
#*    *##if ( !$stringUtils.isNullOrEmpty($med.atc) )
#*        *##if ( !$stringUtils.isNullOrEmpty($med.genericName) )
                            <code code="$med.atc" codeSystem="2.16.840.1.113883.6.73" codeSystemName="whoATC" displayName="$med.genericName"/>
#*        *##else
                            <code code="$med.atc" codeSystem="2.16.840.1.113883.6.73" codeSystemName="whoATC"/>
#*        *##end
#*    *##end
#*    *##if ( $stringUtils.isNullOrEmpty($med.regionalIdentifier) && $stringUtils.isNullOrEmpty($med.atc) )
                            <code nullFlavor="NI"/>
#*    *##end
#*    *##if ( !$stringUtils.isNullOrEmpty($med.genericName) )
                            <name>$med.genericName</name>
#*    *##elseif ( !$stringUtils.isNullOrEmpty($med.brandName) )
                            <name>$med.brandName</name>
#*    *##else
                            <name nullFlavor="NI"/>
#*    *##end
#*    *##if ( !$stringUtils.isNullOrEmpty($med.brandName) )
                            <e2e:desc>$med.brandName</e2e:desc>
#*    *##end
#*    *##if( $e2e.formCodeMap($med.drugForm) )
                            <e2e:formCode code="$e2e.formCodeMap($med.drugForm)" displayName="$med.drugForm" codeSystem="2.16.840.1.113883.19.5.3" codeSystemName="HL7 Orderable Drug Form"/>
#*    *##elseif ( !$stringUtils.isNullOrEmpty($med.drugForm) )
                            <e2e:formCode code="TBD" displayName="$med.drugForm" codeSystem="2.16.840.1.113883.19.5.3" codeSystemName="HL7 Orderable Drug Form"/>
#*    *##end
#*    *##if ( ( !$stringUtils.isNullOrEmpty($med.dosage) && !$stringUtils.isNullOrEmpty($med.unit) ) || !$stringUtils.isNullOrEmpty($med.genericName) )
                            <e2e:ingredient classCode="INGR">
#*        *##if ( !$stringUtils.isNullOrEmpty($med.dosage) && !$stringUtils.isNullOrEmpty($med.unit) )
                              <e2e:quantity value="$med.dosage.trim().replaceAll(" .*", "")" unit="$med.unit"/>
#*        *##end
#*        *##if ( !$stringUtils.isNullOrEmpty($med.genericName) )
                              <e2e:ingredient classCode="MMAT" determinerCode="KIND">
                                <e2e:code code="TBD" displayName="$med.genericName" codeSystem="TBD" codeSystemName="ClinicalDrug"/>
                                <e2e:name>$med.genericName</e2e:name>
                              </e2e:ingredient>
#*        *##else
                              <e2e:ingredient nullFlavor="NI"/>
#*        *##end
                            </e2e:ingredient>
#*    *##end
                          </manufacturedLabeledDrug>
                        </manufacturedProduct>
                      </consumable>
                    </substanceAdministration>
                  </entryRelationship>
                  <!-- PRN -->
                  <entryRelationship typeCode="SUBJ" contextConductionInd="true">
                    <templateId root="2.16.840.1.113883.3.1818.10.4.37"/>
                    <!-- Order Indicator -->
                    <observation classCode="OBS" moodCode="EVN">
                      <code code="PRNIND" codeSystem="2.16.840.1.113883.3.3068.10.6.3" codeSystemName="ObservationType-CA-Pending" displayName="PRN Indicator"/>
#*    *##if( $med.isPrn() )
                      <value xsi:type="BL" value="true"/>
#*    *##else
                      <value xsi:type="BL" value="false"/>
#*    *##end
                    </observation>
                  </entryRelationship>
#*    *##if( !$stringUtils.isNullOrEmpty($med.specialInstruction) )
                  <!-- Instructions to Patient -->
                  <entryRelationship typeCode="SUBJ" inversionInd="true">
                    <templateId root="2.16.840.1.113883.3.1818.10.4.35"/>
                    <!--Instruction Observation-->
                    <observation classCode="OBS" moodCode="EVN">
                      <code code="INSTRUCT" codeSystem="2.16.840.1.113883.3.3068.10.6.3" codeSystemName="ObservationType-CA-Pending" displayName="Instructions"/>
                      <text representation="TXT" mediaType="text/plain">$patient.cleanString($med.specialInstruction)</text>
                      <participant typeCode="PRCP" contextControlCode="OP">
                        <participantRole classCode="ROL">
                          <code code="PAT" codeSystem="2.16.840.1.113883.3.3068.10.8.30" codeSystemName="RoleClass" displayName="InstructionTargetRole"/>
                        </participantRole>
                      </participant>
                    </observation>
                  </entryRelationship>
#*    *##end
                </substanceAdministration>
              </entryRelationship>
#*    *##set( $previousDin = $currentDin )
#**##end
            </substanceAdministration>
          </entry>
        </section>
      </component>
#else
      <component typeCode="COMP" contextConductionInd="true">
        <section classCode="DOCSECT" moodCode="EVN">
          <templateId root="2.16.840.1.113883.3.1818.10.2.19"/>
          <code code="10160-0" codeSystem="2.16.840.1.113883.6.1" codeSystemName="LOINC" displayName="History of Medication Use"/>
          <title>Medications and Prescriptions - Medication List [without entries]</title>
          <text mediaType="text/x-hl7-text+xml">$noInformation</text>
          <entry nullFlavor="NI" typeCode="DRIV" contextConductionInd="true">
            <templateId root="2.16.840.1.113883.3.1818.10.3.18"/>
            <substanceAdministration nullFlavor="NI" classCode="SBADM" moodCode="EVN">
              <id root="2.16.840.1.113883.3.3331" extension="Medications-0" assigningAuthorityName="OSCAR EMR"/>
              <consumable typeCode="CSM">
                <templateId root="2.16.840.1.113883.3.1818.10.4.16"/>
                <manufacturedProduct classCode="MANU">
                  <manufacturedLabeledDrug classCode="MMAT" determinerCode="KIND">
                    <code nullFlavor="NI"/>
                    <name nullFlavor="NI"/>
                  </manufacturedLabeledDrug>
                </manufacturedProduct>
              </consumable>
              <entryRelationship nullFlavor="NI" typeCode="SUBJ" contextConductionInd="true">
                <observation nullFlavor="NI" classCode="OBS" moodCode="EVN">
                  <code code="UNBOUND" codeSystem="2.16.840.1.113883.3.3068.10.6.3" codeSystemName="ObservationType-CA-Pending"/>
                </observation>
              </entryRelationship>
            </substanceAdministration>
          </entry>
        </section>
      </component>
#end
<!--
********************************************************
Orders & Requests
********************************************************
-->
      <component typeCode="COMP" contextConductionInd="true">
        <section classCode="DOCSECT" moodCode="EVN">
          <templateId root="2.16.840.1.113883.3.1818.10.2.20"/>
          <code code="REQS" codeSystem="2.16.840.1.113883.3.3068.10.6.2" codeSystemName="SectionType-CA-Pending" displayName="Problems list Reported"/>
          <title>Orders and Requests (without entries)</title>
          <text mediaType="text/x-hl7-text+xml">$notSupported</text>
          <entry nullFlavor="NI" typeCode="DRIV" contextConductionInd="true">
            <observation nullFlavor="NI" classCode="OBS" moodCode="RQO">
              <id root="2.16.840.1.113883.3.3331" extension="Referrals-0" assigningAuthorityName="OSCAR EMR"/>
              <code nullFlavor="NA"/>
              <text nullFlavor="NI"/>
              <effectiveTime nullFlavor="NI"/>
              <performer nullFlavor="NI" typeCode="PRF">
                <assignedEntity nullFlavor="NI" classCode="ASSIGNED">
                  <id nullFlavor="NI"/>
                </assignedEntity>
              </performer>
              <author nullFlavor="NI" typeCode="AUT" contextControlCode="OP">
                <time nullFlavor="NI"/>
                <assignedAuthor classCode="ASSIGNED">
                  <id nullFlavor="NI"/>
                  <assignedPerson classCode="PSN" determinerCode="INSTANCE">
                    <name nullFlavor="NI"/>
                  </assignedPerson>
                </assignedAuthor>
              </author>
            </observation>
          </entry>
        </section>
      </component>
<!--
********************************************************
Problems and Conditions - Problem List
********************************************************
-->
#if ( $patient.hasProblems() )
      <component typeCode="COMP" contextConductionInd="true">
        <section classCode="DOCSECT" moodCode="EVN">
          <templateId root="2.16.840.1.113883.3.1818.10.2.21.1"/>
          <code code="11450-4" codeSystem="2.16.840.1.113883.6.1" codeSystemName="LOINC" displayName="Problems List Reported"/>
          <title>Problems and Conditions - Problem List [with entries]</title>
          <text mediaType="text/x-hl7-text+xml">
            <list>
#**##foreach ( $problem in $patient.getProblems() )
              <item>$!patient.getICD9Description("$problem.getDxresearchCode()").replaceAll("&","AND") (ICD9: $problem.getDxresearchCode())</item>
#**##end
            </list>
          </text>
#**##foreach ( $problem in $patient.getProblems() )
#*    *##if ( $problem.codingSystem == "icd9" )
          <entry typeCode="DRIV" contextConductionInd="true">
            <templateId root="2.16.840.1.113883.3.1818.10.3.15"/>
            <!-- Problem List Observation -->
            <observation classCode="OBS" moodCode="EVN">
              <id root="2.16.840.1.113883.3.3331" extension="ProblemList-$problem.id"  assigningAuthorityName="OSCAR EMR"/>
              <code code="282291009" displayName="Diagnosis" codeSystem="2.16.840.1.113883.6.69" codeSystemName="SNOMED-CT"/>
              <text representation="TXT" mediaType="text/plain">$patient.getICD9Description("$problem.getDxresearchCode()").replaceAll("&","AND")</text>
#*        *##if ( $problem.status == "A" )
              <statusCode code="active"/>
#*        *##else
              <statusCode code="completed"/>
#*        *##end
#*    *##if ( $problem.getStartDate() )
              <effectiveTime xsi:type="IVL_TS">
                <low value="$dateTool.format('yyyyMMdd', $problem.getStartDate())"/>
              </effectiveTime>
#*    *##else
              <effectiveTime nullFlavor="UNK"/>
#*    *##end
              <value xsi:type="CD" nullFlavor="UNK"/>
              <!-- Diagnosing Provider -->
              <author typeCode="AUT" contextControlCode="OP">
                <templateId root="2.16.840.1.113883.3.1818.10.4.2"/>
                <!-- Author Participation -->
#*        *##if ( $problem.getUpdateDate() )
                <time value="$dateTool.format('yyyyMMdd', $problem.getUpdateDate())"/>
#*        *##else
                <time nullFlavor="UNK"/>
#*        *##end
                <assignedAuthor classCode="ASSIGNED">
                  <id root="2.16.840.1.113883.3.40.2.11" extension="$patient.getProviderID($demographic.providerNo)" use="BUS"/>
                  <assignedPerson classCode="PSN" determinerCode="INSTANCE">
                    <name use="L">
                      <given>$patient.getProviderFirstName($demographic.providerNo)</given>
                      <family>$patient.getProviderLastName($demographic.providerNo)</family>
                    </name>
                  </assignedPerson>
                </assignedAuthor>
              </author>
              <!-- Diagnosis Billing Code -->
              <entryRelationship typeCode="COMP" contextConductionInd="true">
                <templateId root="2.16.840.1.113883.3.1818.10.4.28"/>
                <!-- Secondary Code (ICD9) -->
                <observation classCode="OBS" moodCode="EVN">
                  <code code="ICD9CODE" displayName="Billing Code" codeSystem="2.16.840.1.113883.3.3068.10.6.3" codeSystemName="ObservationType-CA-Pending"/>
                  <value xsi:type="CD" code="$problem.getDxresearchCode()" displayName="$patient.getICD9Description("$problem.getDxresearchCode()").replaceAll("&","AND")" codeSystem="2.16.840.1.113883.6.42" codeSystemName="ICD9"/>
                </observation>
              </entryRelationship>
              <!-- Diagnosis Date -->
              <entryRelationship typeCode="SUBJ" contextConductionInd="true" inversionInd="true">
                <templateId root="2.16.840.1.113883.3.1818.10.4.4"/>
                <!-- Date Observation -->
                <observation classCode="OBS" moodCode="EVN">
                  <code code="DATEOBS" displayName="Date Observation" codeSystem="2.16.840.1.113883.3.3068.10.6.3" codeSystemName="ObservationType-CA-Pending"/>
#*        *##if ( $problem.getUpdateDate() )
                  <effectiveTime xsi:type="IVL_TS">
                    <low value="$dateTool.format('yyyyMMddhhmmss', $problem.getUpdateDate())"/>
                  </effectiveTime>
#*        *##else
                  <effectiveTime nullFlavor="UNK"/>
#*        *##end
                </observation>
              </entryRelationship>
            </observation>
          </entry>
#*    *##end
#**##end
        </section>
      </component>
#else
      <component typeCode="COMP" contextConductionInd="true">
        <section classCode="DOCSECT" moodCode="EVN">
          <templateId root="2.16.840.1.113883.3.1818.10.2.21"/>
          <code code="11450-4" codeSystem="2.16.840.1.113883.6.1" codeSystemName="LOINC" displayName="Problems List Reported"/>
          <title>Problems and Conditions - Problem List [without entries]</title>
          <text mediaType="text/x-hl7-text+xml">$noInformation</text>
          <entry nullFlavor="NI" typeCode="DRIV" contextConductionInd="true">
            <templateId root="2.16.840.1.113883.3.1818.10.3.15"/>
            <observation nullFlavor="NI" classCode="OBS" moodCode="EVN">
              <id root="2.16.840.1.113883.3.3331" extension="ProblemList-0" assigningAuthorityName="OSCAR EMR"/>
              <code nullFlavor="NI"/>
              <author nullFlavor="NI" typeCode="AUT" contextControlCode="OP">
                <time nullFlavor="NI"/>
                <assignedAuthor classCode="ASSIGNED">
                  <id nullFlavor="NI"/>
                  <assignedPerson classCode="PSN" determinerCode="INSTANCE">
                    <name nullFlavor="NI"/>
                  </assignedPerson>
                </assignedAuthor>
              </author>
            </observation>
          </entry>
        </section>
      </component>
#end
<!--
********************************************************
Risk Factors
********************************************************
-->
#if ( $patient.hasRiskFactorsandPersonalHistory() )
      <component typeCode="COMP" contextConductionInd="true">
        <section classCode="DOCSECT" moodCode="EVN">
          <templateId root="2.16.840.1.113883.3.1818.10.2.24.1"/>
          <code code="46467-7" codeSystem="2.16.840.1.113883.6.1" codeSystemName="LOINC" displayName="Risk Factors"/>
          <title>Risk Factors [with entries]</title>
          <text mediaType="text/x-hl7-text+xml">
            <list>
#**##foreach ( $risk in $patient.getRiskFactorsandPersonalHistory() )
              <item>$!patient.cleanString($risk.note)</item>
#**##end
            </list>
          </text>
#**##foreach ( $risk in $patient.getRiskFactorsandPersonalHistory() )
          <entry typeCode="DRIV" contextConductionInd="true">
            <templateId root="2.16.840.1.113883.3.1818.10.3.17"/>
            <!-- Risk Factors Organizer -->
            <organizer classCode="CLUSTER" moodCode="EVN">
              <id root="2.16.840.1.113883.3.3331" extension="RiskFactors-$risk.id" assigningAuthorityName="OSCAR EMR"/>
              <code code="80943009" displayName="Risk factor (observable entity)" codeSystem="2.16.840.1.113883.3.1818.10.2.8.3" codeSystemName="SNOMED-CT"/>
#*    *##if ( !$risk.isArchived() )
              <statusCode code="active"/>
#*    *##else
              <statusCode code="complete"/>
#*    *##end
              <!-- Observation Author -->
              <author typeCode="AUT" contextControlCode="OP">
                <templateId root="2.16.840.1.113883.3.1818.10.4.2"/>
                <!-- Author Participation -->
#*    *##if ( $risk.getUpdate_date() )
                <time value="$dateTool.format('yyyyMMdd', $risk.getUpdate_date())"/>
#*    *##else
                <time nullFlavor="UNK"/>
#*    *##end
                <assignedAuthor classCode="ASSIGNED">
                  <id root="2.16.840.1.113883.3.40.2.11" extension="$patient.getProviderID($risk.providerNo)" use="BUS"/>
                  <assignedPerson classCode="PSN" determinerCode="INSTANCE">
                    <name use="L">
                      <given>$patient.getProviderFirstName($risk.providerNo)</given>
                      <family>$patient.getProviderLastName($risk.providerNo)</family>
                    </name>
                  </assignedPerson>
                </assignedAuthor>
              </author>
              <!-- Component Observation -->
              <component typeCode="COMP" contextConductionInd="true">
                <observation classCode="OBS" moodCode="EVN">
                  <id root="2.16.840.1.113883.3.3331" extension="RiskFactors-$risk.id" assigningAuthorityName="OSCAR EMR"/>
#*    *##if ( !$stringUtils.isNullOrEmpty($risk.Billing_code) )
                  <code code="$risk.Billing_code" displayName="$patient.getICD9Description("$risk.getBilling_code()").replaceAll("&","AND")" codeSystem="2.16.840.1.113883.6.42" codeSystemName="ICD9"/>
#*    *##else
                  <code nullFlavor="NI"/>
#*    *##end
                  <text representation="TXT" mediaType="text/plain">$!patient.cleanString($risk.note)</text>
#*    *##if ( $risk.getObservation_date() )
                  <effectiveTime xsi:type="IVL_TS">
                    <low value="$dateTool.format('yyyyMMddHHmmss', $risk.getObservation_date())"/>
                  </effectiveTime>
#*    *##else
                  <effectiveTime nullFlavor="UNK"/>
#*    *##end
                  <value xsi:type="CD" nullFlavor="NI"/>
                </observation>
              </component>
            </organizer>
          </entry>
#**##end
        </section>
      </component>
#else
      <component typeCode="COMP" contextConductionInd="true">
        <section classCode="DOCSECT" moodCode="EVN">
          <templateId root="2.16.840.1.113883.3.1818.10.2.24"/>
          <code code="46467-7" codeSystem="2.16.840.1.113883.6.1" codeSystemName="LOINC" displayName="Risk Factors"/>
          <title>Risk Factors [without entries]</title>
          <text mediaType="text/x-hl7-text+xml">$noInformation</text>
          <entry nullFlavor="NI" typeCode="DRIV" contextConductionInd="true">
            <templateId root="2.16.840.1.113883.3.1818.10.3.17"/>
            <organizer nullFlavor="NI" classCode="CLUSTER" moodCode="EVN">
              <code nullFlavor="NA"/>
              <statusCode nullFlavor="NA"/>
              <component nullFlavor="NI" typeCode="COMP" contextConductionInd="true">
                <observation nullFlavor="NI" classCode="OBS" moodCode="EVN">
                  <id root="2.16.840.1.113883.3.3331" extension="RiskFactors-0" assigningAuthorityName="OSCAR EMR"/>
                  <code nullFlavor="NI"/>
                  <value xsi:type="CD" nullFlavor="NI"/>
                </observation>
              </component>
            </organizer>
          </entry>
        </section>
      </component>
#end
    </structuredBody>
  </component>
</hl7:ClinicalDocument>
